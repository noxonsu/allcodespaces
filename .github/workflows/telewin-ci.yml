name: TeleWin CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

permissions:
  contents: read

env:
  PIP_DISABLE_PIP_VERSION_CHECK: '1'
  POETRY_VIRTUALENVS_CREATE: 'true'
  POETRY_VIRTUALENVS_IN_PROJECT: 'true'

jobs:
  tests:
    name: ${{ matrix.name }} tests
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.allow-failure || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Django backend
            workdir: web_app
            install: |
              python3 -m pip install --upgrade pip
              python3 -c "
              import tomllib
              from pathlib import Path

              data = tomllib.loads(Path('pyproject.toml').read_text())
              deps = data.get('project', {}).get('dependencies', [])
              dev = data.get('dependency-groups', {}).get('dev', [])

              with Path('requirements-ci.txt').open('w', encoding='utf-8') as req_file:
                  for requirement in [*deps, *dev]:
                      req_file.write(f'{requirement}\n')
              "
              python3 -m pip install -r requirements-ci.txt
            test: |
              python3 -m pytest -vv
            pythonpath: web_app
          - name: Telegram bot
            workdir: bot
            allow-failure: true
            install: |
              python3 -m pip install --upgrade pip
              python3 -m pip install poetry
              poetry install --with dev --no-interaction
            test: |
              poetry run pytest -vv
            pythonpath: bot
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        working-directory: ${{ matrix.workdir }}
        run: ${{ matrix.install }}

      - name: Run pytest
        working-directory: ${{ matrix.workdir }}
        env:
          PYTHONPATH: ${{ github.workspace }}/${{ matrix.pythonpath }}
          DJANGO_SETTINGS_MODULE: web_app.settings
          BOT_TOKEN: fake-token-for-ci
          SCHEMA_DOMAIN: https://example.com
          DB_ENGINE: sqlite3
          DB_NAME: ':memory:'
          DB_USERNAME: ''
          DB_PASS: ''
          DB_HOST: ''
          DB_PORT: ''
          SECRET_KEY: fake-secret-key-for-ci-tests
          DEBUG: 'False'
        run: ${{ matrix.test }}

  smoke-tests:
    name: Puppeteer smoke tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run user smoke tests
        run: npm run test:user

      - name: Run admin smoke tests
        env:
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: npm run test:admin

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-screenshots
          path: screenshots/
          retention-days: 7

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-reports
          path: screenshots/*.json
          retention-days: 7

  build-images:
    name: Build Docker images
    runs-on: ubuntu-latest
    needs: [tests, smoke-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Build backend image
        run: docker build -t telewin-backend:ci -f web_app/dockerb/Dockerfile web_app

      - name: Build bot image
        run: docker build -t telewin-bot:ci -f bot/docker/Dockerfile bot
