# Soft delete каналов (эпик 1.4)

## Что сделано
- Добавлен флаг `is_deleted` у Channel и миграция; статус активности теперь учитывает soft delete.
- API/админка скрывают удалённые каналы (кроме суперюзера), выбор каналов в формах исключает удалённые; суперюзер может выставлять/фильтровать флаг.
- Финансовые и плановые агрегации кампаний исключают удалённые каналы и связанные campaign-channel; плановые проверки бюджета и задачи автопубликации учитывают только живые каналы.
- При повторном подключении бота флаг soft delete сбрасывается; бот-парсер знает про `is_deleted`.
- Добавлены фабрики/тесты на soft delete и обновлено README коротким примечанием.

## Проверено
- `timeout 120s python3 -m pytest web_app/core/tests/test_unittest.py -k "soft_delete or campaign_totals_ignore_deleted_channels" -q` *(упало на ранней загрузке: ModuleNotFoundError: django; нужно установить зависимости/настроить Django окружение перед повтором).* 

## Как тестировать (для тестера)
1. Применить миграции: `cd web_app && python3 manage.py migrate && cd ..`.
2. Проверить API: `curl -X GET "http://localhost:8000/api/channel/"` — удалённые каналы не возвращаются (кроме суперюзера).
3. Админка: зайти под суперюзером → список каналов (`/core/channel/`) — увидеть фильтр `is_deleted`, изменить флаг на карточке; под не-суперюзером канал с `is_deleted=True` не виден/не редактируется.
4. Бот-переустановка: повторно вызвать создание канала с тем же `tg_id` — `is_deleted` должен сброситься, `is_bot_installed`=True.
5. Кампания: добавить в кампанию удалённый канал не должно позволяться (валидация), метрики кампании не должны учитывать удалённые каналы.

## Деплой/запуск
- После миграций перезапускать python-бекенд не требуется (dev режим отслеживает изменения), но если есть pm2 процессы — перезапуск через pm2 по регламенту.
- Для проверки через бота/таск автопубликации убедитесь, что cron/celery запущены и окружение настроено.

# Предпросмотр креативов (эпик 5.2)

## Что сделано
- Добавлен одноразовый токен предпросмотра `MessagePreviewToken` и API:
  - `POST /api/message/<id>/preview/` — создаёт токен, проверяет права, отдаёт deeplink `t.me/<bot>?start=<token>`, пробует уведомить бота (`/telegram/preview-token`).
  - `POST /api/message/preview/resolve/` — бот валидирует/гасит токен и получает данные креатива.
- В админке креатива появилась кнопка «Отправить предпросмотр», которая вызывает API и показывает ссылку.
- Токены одноразовые, с TTL 30 минут, хранятся в админке (read-only).

## Проверено
- `timeout 120s python3 -m pytest web_app/core/tests/test_message_preview.py -q` *(Django не установлен в окружении, нужна установка зависимостей перед прогоном).* 

## Как тестировать (для тестера, стейдж `https://telewin.wpmix.net`)
1. Откройте админку и войдите (роль с доступом к креативам).
2. Откройте карточку любого креатива (Меню Core → Creative) и нажмите кнопку «Отправить предпросмотр».
3. Убедитесь, что появилась ссылка вида `https://t.me/<бот>?start=<token>` и подсказка, до какого времени она действует.
4. Перейдите по ссылке в Telegram: бот должен прислать пост. Повторное открытие ссылки должно сообщить, что токен уже использован/просрочен.
5. В разделе Core → Message preview tokens видно созданный токен (только для чтения), статус использования/истечения отображается.
