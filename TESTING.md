# TESTING.md

Документация для тестирования платформы TeleWin - биржи рекламы в Telegram.

## Тестовая среда

**URL:** https://telewin.wpmix.net/

**Telegram бот (DEV):** `@nashbudjetbot`

**Официальная инструкция:** https://telewin.online/instruction

## Тестовые учетные записи

### Заказчик (рекламодатель)
- **Логин:** AlexeyFrolov
- **Пароль:** 1234Fgtn@
- **Доступ:** Создание и управление рекламными кампаниями

### Владелец каналов (паблишер)
- **Авторизация:** Через Telegram Login (см. тест-кейс ниже)
- **Доступ:** Управление каналами, подтверждение публикаций

## Основные тест-кейсы

### 1. Регистрация через Telegram (Publisher Flow)

**Предусловие:**
- В Telegram есть личный аккаунт (не привязанный к TeleWin)
- Установлено приложение Telegram Desktop или доступен Telegram Web

**Шаги:**

1. **Запуск бота**
   - В Telegram найдите бота `@nashbudjetbot`
   - Нажмите `Start` и дождитесь приветственного сообщения
   - Этим шагом создаётся запись ChannelAdmin и разрешается работа с ботом

2. **Вход в систему**
   - Откройте в браузере (рекомендуется режим инкогнито): `https://telewin.wpmix.net/login/`
   - Страница автоматически редиректит на форму Jazzmin логина
   - Игнорируйте поля логина/пароля
   - Нажмите большую кнопку **Telegram Login** (под синей кнопкой «Log in»)

3. **Подтверждение в Telegram**
   - В открывшемся pop-up выберите свой Telegram-аккаунт
   - Подтвердите доступ
   - При необходимости разрешите браузеру открыть Telegram Desktop/Web
   - После подтверждения будет редирект на `/api/login/tg`, затем в личный кабинет

**Ожидаемый результат:**
- Попадание на страницу `/core/campaignchannel/`
- Слева отображается меню Jazzmin
- В правом верхнем углу виден ник из Telegram
- Список кампаний пока пуст, но доступ получен

---

### 2. Добавление нового Telegram-канала

**Предусловие:**
- В Telegram создан тестовый канал, где вы являетесь владельцем
- Бот `@nashbudjetbot` уже запущен в личных сообщениях (шаг из предыдущего кейса)

**Шаги:**

1. **Создание канала в Telegram**
   - Меню → «Создать канал»
   - Задайте название и описание
   - Завершите мастер (можно оставить канал приватным и без подписчиков)

2. **Добавление бота администратором**
   - В карточке канала: «Информация» → «Администраторы» → «Добавить администратора»
   - В поиске введите `@nashbudjetbot`
   - Выберите бота и подтвердите добавление

3. **Настройка прав бота**
   - Включите права:
     - ✅ Публикация сообщений
     - ✅ Редактирование сообщений
     - ✅ Приглашение по ссылке
   - Сохраните настройки
   - Отправьте любое тестовое сообщение в канал (чтобы бот зафиксировал активность)

4. **Проверка в личном кабинете**
   - Вернитесь на `https://telewin.wpmix.net`
   - Откройте «Каналы» в левом меню (или `/core/channel/`)
   - Обновите страницу через 30-60 секунд

**Ожидаемый результат:**
- Новый канал появился в списке
- Статус: «На модерации» (Pending)
- Бот: Да (✓)
- Канал автоматически привязан к вашему ChannelAdmin
- Канал виден в фильтре «Мои каналы» на `/core/campaignchannel/`

---

### 3. Создание рекламной кампании (Advertiser Flow)

**Предусловие:**
- Использовать dev-домен `https://telewin.wpmix.net/`
- Авторизация через тестового бота `@nashbudjetbot` (не `telewin_0001_bot`)
- Telegram-аккаунт готов к логину, куки очищены

**Шаги:**

1. **Авторизация**
   - Открыть `https://telewin.wpmix.net/`
   - Пройти Telegram Login через `@nashbudjetbot`
   - Убедиться, что профиль подтянулся

2. **Создание новой кампании**
   - Выбрать формат размещения:
     - `Спонсорство` (краткий текст до 160 символов, 1 кнопка)
     - `Фикс-слот` (публикация в конкретное время и день недели)
     - `Автопилот` (автоматическое распределение)
   - Заполнить обязательные поля:
     - Название кампании
     - Бюджет/ставка (CPM)
     - Даты старта и завершения
     - Для фикс-слота: дата и время публикации
     - Таргетинг (категории, страны, языки)

3. **Добавление креатива**
   - Создать новый креатив или выбрать существующий:
     - Текст сообщения
     - Медиа (изображение/видео) - опционально
     - Кнопки со ссылками
     - Юридические данные (ИНН, ERID)
   - Проверить валидацию:
     - Для спонсорства: текст ≤ 160 символов, 1 кнопка
     - Формат креатива совпадает с форматом кампании
   - Проверить предпросмотр креатива

4. **Сохранение кампании**
   - Нажать «Сохранить»
   - Убедиться, что кампания появилась в списке
   - Проверить отображение:
     - Корректный статус («На паузе» / «Активна»)
     - Правильные даты старта/завершения
     - Суммы и лимиты отображаются

5. **Запуск кампании**
   - Открыть кампанию на редактирование
   - Изменить статус на «Активна»
   - Подтвердить действие
   - Дождаться смены статуса на "запланирована"/"активна"
   - Проверить, что:
     - Слоты/окна публикации отражаются в календаре
     - Бюджеты пересчитываются корректно

6. **Редактирование кампании**
   - Повторно открыть кампанию
   - Отредактировать поле (например, бюджет или время слота)
   - Сохранить изменения
   - Убедиться, что:
     - Изменения применены
     - Статус не сломался
     - Валидация проходит корректно

7. **Завершение/отмена кампании**
   - Перевести кампанию в завершённое состояние или статус «На паузе»
   - Проверить:
     - Корректный статус в списке
     - Отсутствие дальнейших публикаций
     - Недоступность редактирования после завершения

**Ожидаемый результат:**
- ✅ Авторизация проходит через `@nashbudjetbot`
- ✅ Кампании создаются во всех форматах без ошибок валидации
- ✅ Статусы и расписания отображаются корректно
- ✅ Редактирование сохраняется и валидируется
- ✅ Завершение/отмена не вызывает публикаций
- ✅ Бюджеты пересчитываются автоматически

---

### 4. Подтверждение публикации (Publisher Flow)

**Предусловие:**
- Канал добавлен в систему и подтверждён модератором (статус: Confirmed)
- Существует активная кампания с вашим каналом
- У канала включена настройка "Требует ручного подтверждения"

**Шаги:**

1. **Просмотр назначенных кампаний**
   - Войти в систему через Telegram Login
   - Перейти в раздел «Статистика» (`/core/campaignchannel/`)
   - Отфильтровать по своим каналам

2. **Подтверждение публикации**
   - Найти запись со статусом «Ожидает подтверждения» (Planned)
   - Открыть запись
   - Проверить детали кампании и креатива
   - Изменить статус на «Подтверждено» (Confirmed)
   - Сохранить

3. **Проверка публикации**
   - Дождаться времени публикации (для фикс-слота)
   - Проверить, что сообщение опубликовано в Telegram-канале
   - Статус изменился на «Опубликовано» (Published)
   - Заполнились данные: дата публикации, ID поста

**Ожидаемый результат:**
- ✅ Список кампаний отфильтрован корректно
- ✅ Подтверждение сохраняется
- ✅ Публикация происходит в назначенное время
- ✅ Статус обновляется автоматически
- ✅ Метрики начинают собираться

---

## Валидации и ограничения

### Формат "Спонсорство"
- Максимальная длина текста: 160 символов
- Максимум кнопок: 1
- При нарушении: ошибка валидации, сохранение невозможно

### Формат "Фикс-слот"
- Обязательно: выбор слота публикации (день недели + время)
- Слот должен принадлежать выбранному каналу
- Время публикации не может быть в прошлом
- При нарушении: ошибка валидации

### Бюджеты
- Суммарный бюджет каналов не должен превышать бюджет кампании
- При превышении: кампания переводится на паузу автоматически
- Отрицательные значения CPM/показов: запрещены

### Даты
- Дата старта не может быть раньше текущей даты (при создании)
- Дата завершения не может быть раньше даты старта
- Нельзя добавить канал в завершённую кампанию
- При нарушении: ошибка валидации

### Каналы
- Канал должен поддерживать формат кампании
- Удалённый канал (is_deleted=True) нельзя добавить в кампанию
- Неактивный канал (статус ≠ Confirmed) нельзя использовать
- При нарушении: ошибка валидации

---

## Известные особенности

1. **Soft delete каналов**
   - Удалённые каналы (is_deleted=True) скрыты из списков
   - Не участвуют в расчётах выплат
   - Старые кампании с удалёнными каналами сохраняют историю

2. **Автоматическая синхронизация**
   - При добавлении бота в канал данные появляются через 30-60 секунд
   - Метрики (подписчики, охват, ER) обновляются периодически
   - Статус публикации обновляется через Celery задачи

3. **Celery Beat расписание**
   - Проверка запланированных публикаций: каждую минуту
   - Обновление метрик каналов: согласно расписанию в django_celery_beat
   - Для проверки задач: `/django_celery_beat/periodictask/`

4. **Telegram OAuth**
   - Виджет Telegram Login работает только на HTTPS
   - Куки устанавливаются на 48 часов
   - При проблемах: очистить куки и повторить авторизацию

---

## Чек-лист для регрессионного тестирования

### Авторизация
- [ ] Telegram Login работает для новых пользователей
- [ ] Telegram Login работает для существующих пользователей
- [ ] Сессия сохраняется при обновлении страницы
- [ ] Logout корректно завершает сессию
- [ ] Стандартный логин/пароль работает для заказчиков

### Каналы
- [ ] Бот автоматически обнаруживает новые каналы
- [ ] Метрики каналов отображаются корректно
- [ ] Фильтрация по статусам работает
- [ ] Модерация каналов (подтверждение/отклонение)
- [ ] Удаление каналов (soft delete)
- [ ] Настройка слотов публикации

### Кампании
- [ ] Создание кампании "Спонсорство"
- [ ] Создание кампании "Фикс-слот"
- [ ] Создание кампании "Автопилот"
- [ ] Валидация полей при создании
- [ ] Редактирование кампании
- [ ] Изменение статуса (Активна/На паузе)
- [ ] Добавление/удаление каналов
- [ ] Расчёт бюджетов

### Креативы
- [ ] Создание креатива с текстом
- [ ] Загрузка изображения
- [ ] Загрузка видео
- [ ] Добавление кнопок со ссылками
- [ ] Валидация для формата "Спонсорство"
- [ ] Предпросмотр креатива
- [ ] Токены предпросмотра работают

### Публикации
- [ ] Ручное подтверждение публикации
- [ ] Автоматическая публикация по расписанию
- [ ] Публикация фикс-слота в назначенное время
- [ ] Обновление статуса после публикации
- [ ] Сбор метрик (показы, клики)
- [ ] Отклонение публикации

### Статистика
- [ ] Отображение показов (impressions_fact)
- [ ] Отображение кликов
- [ ] Расчёт CTR
- [ ] Расчёт заработанных средств
- [ ] Фильтрация по датам
- [ ] Экспорт в Excel

### API
- [ ] `/api/about` возвращает информацию о компании
- [ ] `/api/campaign-channel/{id}/click/` регистрирует клик
- [ ] `/api/message/{id}/preview/` предпросмотр креатива
- [ ] Swagger доступен на `/swagger/`
- [ ] Аутентификация через токены работает

---

## Контакты для вопросов

- **GitHub Issues:** https://github.com/[your-repo]/TELEWIN/issues
- **Telegram Support:** @nashbudjetbot
- **Документация:** https://telewin.online/instruction

---

**Последнее обновление:** 2025-11-17
