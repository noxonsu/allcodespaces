# Декомпозиция ТЗ

> Во входящем документе пункт 5.1 встречается дважды. Для однозначной ссылки в этой декомпозиции второй пункт обозначен как 5.2.

## 1. Балансы и выплаты

### 1.1 Расчет баланса для монетизации каналов
- **1.1.1** Спроектировать хранилище промежуточных финансовых показателей (начисления, удержания, выплаты, ожидаемые поступления).
- **1.1.2** Реализовать сервис расчета текущего баланса и доступных к выводу средств с учетом soft-delete каналов и статусов кампаний.
- **1.1.3** Настроить расписание пересчета (cron/Celery beat) и событийный пересчет при операциях, влияющих на баланс.
- **1.1.4** Предоставить API/ORM-метод для получения балансов по каналу и агрегированно по юрлицу.
- **1.1.5** Обновить интерфейс, чтобы отображать рассчитанные значения и уведомлять о расхождениях.

### 1.2 Сущность «Юридическое лицо»
- **1.2.1** Добавить модель юрлица (реквизиты, статус, контакты) и миграции.
- **1.2.2** Создать раздел админки: список, фильтры, карточка редактирования, права доступа.
- **1.2.3** Добавить связь «канал ↔ юрлицо», обеспечить массовое назначение и валидацию.
- **1.2.4** В интерфейсе администраторов каналов предусмотреть режим просмотра и переключение между юрлицами.
- **1.2.5** Отображать агрегированный баланс каждого юрлица и историю операций.

### 1.3 Автосоздание и полуавтоматическое исполнение выплат
- **1.3.1** Ввести сущность «выплата» (сумма, период, реквизиты, статус, инициатор).
- **1.3.2** Настроить автоматическое создание выплат по правилам (порог суммы, периодичность) на уровне юрлица.
- **1.3.3** Реализовать список выплат в карточке юрлица и глобальный реестр выплат с фильтрами.
- **1.3.4** Добавить смену статусов (инициирована, проверена, выполнена, отклонена) с журналом действий.
- **1.3.5** Ограничить права: суперадмин/сотрудник может подтверждать или отклонять выплату, остальные — только просматривать.

### 1.4 «Мягкое» удаление каналов
- **1.4.1** Добавить флаг `is_deleted` в модель канала и миграцию.
- **1.4.2** Фильтровать этот флаг во всех списках/фидах (показывать только `false` для обычных ролей).
- **1.4.3** Исключать удаленные каналы из расчетов балансов и формирования выплат.
- **1.4.4** В списке каналов суперадмина добавить фильтр по `is_deleted` и индикаторы состояния.
- **1.4.5** На странице канала разрешить суперадмину переключать флаг, с логированием.
- **1.4.6** Ограничить прямой доступ к удаленному каналу (403) всем, кроме суперадмина.
- **1.4.7** При повторном добавлении бота автоматически сбрасывать `is_deleted` и восстанавливать связанные данные.

## 2. Управление форматами и креативами

### 2.1 Поддержка форматов «Спонсорство», «Фикс-слот», «Автопилот»
- **2.1.1** Добавить поле `format` в модели креатива и кампании, определить enum и миграции.
- **2.1.2** Реализовать разные формы редактирования креатива: лимиты по длине и кнопкам для спонсорства, расширенные поля для других форматов.
- **2.1.3** Сделать поле формата кампании неизменяемым после создания, с валидацией на уровне API и UI.
- **2.1.4** Для фикс-слота добавить обязательные поля даты и времени публикации, с локализацией и проверками таймзон.
- **2.1.5** При добавлении креатива в кампанию фильтровать по совпадению форматов; отображать подсказки при отсутствии подходящих креативов.
- **2.1.6** Ограничить выбор каналов по поддерживаемому формату кампании, с быстрым поиском.
- **2.1.7** Расширить запрос на одобрение публикации новыми параметрами (формат, дата, время) и убедиться, что администратор их видит.

### 2.2 Настройка допустимых форматов на уровне канала
- **2.2.1** На странице редактирования канала добавить чек-лист поддерживаемых форматов и хранение в БД.
- **2.2.2** Добавить флаг «автоматическое утверждение публикаций» и обработку его в маршруте согласования.
- **2.2.3** Для фикс-слота реализовать планировщик доступных таймслотов с возможностью задавать окна по каждому дню недели.
- **2.2.4** Для формата автопилот добавить настройку минимального интервала между публикациями и проверку при планировании.
- **2.2.5** При добавлении канала в кампанию учитывать занятость слотов: блокировать конфликтующие времена, подсвечивать доступные.
- **2.2.6** Обновить API/валидаторы, чтобы несоответствие настройкам канала приводило к понятной ошибке.

### 2.3 Улучшение редактора креативов
- **2.3.1** Добавить поддержку форматирования (bold, italic, ссылки) в UI и преобразование в Telegram-разметку.
- **2.3.2** Для фикс-слота разрешить несколько кнопок, обеспечить drag&drop/упорядочивание.
- **2.3.3** Переписать учет кликов так, чтобы агрегировались данные по каждой кнопке и суммарно.

## 3. Жизненный цикл кампаний

### 3.1 Черновики рекламных кампаний
- **3.1.1** Ввести статус `draft`, отобразить его во всех фильтрах/списках.
- **3.1.2** Изменить логику отправки уведомлений администраторам: для `draft` не отправлять запросы.
- **3.1.3** После смены статуса с `draft` отправлять уведомления всем администраторам, которые еще не подтвердили кампанию.
- **3.1.4** Заблокировать любые публикации для кампаний в `draft`, в том числе из API и бота.
- **3.1.5** Добавить UX-подсказки (баннер, тултип) о необходимости перевести кампанию в активный статус.

### 3.2 Безопасное удаление кампаний
- **3.2.1** Определить, что считается «публикацией» (успешный пост/попытка) и хранить флаг в кампаниях.
- **3.2.2** При запросе на удаление проверять наличие хотя бы одной публикации и блокировать операцию.
- **3.2.3** Отображать пользователю причину блокировки и возможные альтернативы (архивация, soft delete).

## 4. Интеграция с микросервисом парсинга

### 4.1 API-взаимодействие
- **4.1.1** Отправлять микросервису события о появлении/удалении канала, допускающего публикации (webhook/queue).
- **4.1.2** Реализовать endpoint для входящих запросов парсера с валидацией и аутентификацией.
- **4.1.3** Добавить стратегию выбора креатива (по формату, таймслотам, приоритетам).
- **4.1.4** Настроить автоматическую публикацию поста в канале по запросу микросервиса, с логами и повторными попытками.
- **4.1.5** Синхронизировать статусы/ошибки между системами и предоставить мониторинг.

## 5. Отчётность и предпросмотр

### 5.1 Генерация медиаплана
- **5.1.1** В списке кампаний добавить режим выбора нескольких записей и действия «Сформировать медиаплан».
- **5.1.2** Описать шаблон Excel (структура листов, колонки, форматирование) и зафиксировать его в репозитории.
- **5.1.3** Сформировать слой агрегации данных (параметры кампаний, бюджеты, KPI, таймслоты).
- **5.1.4** Реализовать генерацию файла по шаблону (например, openpyxl) и сохранение временных файлов.
- **5.1.5** Вернуть ссылку/кнопку скачивания медиаплана пользователю, логировать операции.

✅ Шаблон и генератор находятся в `web_app/core/media_plan/`. API `POST /api/campaign/generate-media-plan/` формирует файл, сохраняет его в `MEDIA_ROOT/media_plans/` и создаёт запись `MediaPlanGeneration` (история доступна в админке).

### 5.2 Предпросмотр поста через Telegram-бота
- **5.2.1** Добавить в бота команду/кнопку для запроса предпросмотра и передачу `creative_id` в `/start`.
- **5.2.2** Отправлять пользователю ссылку или инлайн-превью поста без изменения статусов кампании.
- **5.2.3** Убедиться, что публикация через бота не учитывается в подсчете показов/кликов; обновить метрики.
- **5.2.4** Обновить документацию для администраторов/менеджеров по работе с предпросмотром.
