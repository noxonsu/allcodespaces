# Проект Аэроклуб

Этот проект состоит из трех частей:
*   **Панель администратора (`admin-app`)**: React-приложение для управления.
*   **Клиентское приложение (`client-app`)**: React-приложение, адаптированное для Telegram Mini App.
*   **Бэкенд (`backend`)**: FastAPI-приложение.

## Структура проекта

```
aeroclub/
├── admin-app/      # React Admin Panel
├── client-app/     # React Telegram Mini App
└── backend/        # FastAPI Backend
```

## Панель администратора (`admin-app`)

Это React-приложение, созданное с помощью Create React App и TypeScript, для управления системой.

### Основные функции:
*   **Страница входа**: Позволяет администраторам войти в систему.
*   **Страница администратора**: Предоставляет панель управления для:
    *   Пользователей (создание, просмотр - полный функционал списка ожидает endpoint на backend)
    *   Пунктов меню (загрузка новых напитков, редактирование существующих - ожидается интеграция с backend)
    *   Заказов (просмотр текущих заказов - ожидается интеграция с backend)
    *   Масштабирование/Локации (управление локациями, генерация QR-кодов - ожидается интеграция с backend)
*   **Страница клиентского приложения**: (Заготовка для клиентского приложения)

### Установка и запуск

1.  **Перейдите в директорию `admin-app`:**
    ```bash
    cd aeroclub/admin-app
    ```
2.  **Установите зависимости:**
    ```bash
    npm install
    ```
3.  **Запустите сервер разработки:**
    ```bash
    npm start
    ```
    Приложение будет доступно по адресу `http://localhost:3000`.

### Взаимодействие с Backend API
*   Страница входа (`src/components/LoginPage.tsx`) взаимодействует с endpoint `/api/v1/auth/token` бэкенда для аутентификации.
*   Страница администратора (`src/components/AdminPage.tsx`) настроена для взаимодействия с различными эндпоинтами API для управления пользователями, меню, заказами и т.д.
*   Базовый URL backend API жестко задан как `http://localhost:8000`.

## Backend (backend)

Backend - это FastAPI приложение.

### Основные функции:
*   **Аутентификация**: JWT-токен аутентификация (`/api/v1/auth/token`).
*   **Управление пользователями**:
    *   Создание пользователей (`POST /api/v1/users/`) - защищено для администратора.
    *   Получение текущего пользователя (`GET /api/v1/users/me/`).
    *   Первоначальная настройка администратора (`POST /api/v1/auth/setup-admin`).
*   **API Endpoints**: Организованы под `/api/v1/` для различных ресурсов (локации, пункты меню, заказы - подробности реализации в `backend/app/api/v1/endpoints/`).
*   **CORS включен**: Разрешает запросы со всех источников (`*`) для разработки.
*   **Обслуживание статических файлов**: Обслуживает загруженные файлы из `/uploads`.

### Установка и запуск:

1.  **Перейдите в директорию backend:**
    ```bash
    cd aeroclub/backend
    ```
2.  **Создайте виртуальное окружение (рекомендуется):**
    ```bash
    python -m venv venv
    source venv/bin/activate  # На Windows: venv\Scripts\activate
    ```
3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```
4.  **Настройте переменные окружения:**
    Создайте файл `.env` в директории `aeroclub/backend`, скопировав `.env.example` (если существует) или создав его вручную.
    Он должен содержать как минимум:
    ```env
    SECRET_KEY=ваш_секретный_ключ
    ACCESS_TOKEN_EXPIRE_MINUTES=30
    ADMIN_USERNAME=ваш_админ_логин
    ADMIN_PASSWORD=ваш_админ_пароль
    # Опционально:
    # TELEGRAM_BOT_TOKEN=токен_вашего_телеграм_бота
    # TELEGRAM_CHAT_ID=id_вашего_телеграм_чата
    ```
5.  **Запустите сервер разработки:**
    ```bash
    uvicorn app.main:app --host 0.0.0.0 --reload
    ```
    или 
    ```
    pm2 start --name allgtps-aeroclub-backend python3 --interpreter python3 -- uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ```
    API будет доступно по адресу `http://localhost:8000`. Документация API находится по адресам `http://localhost:8000/docs` и `http://localhost:8000/redoc`.

## Подключение Frontend к Backend

*   Frontend ожидает, что backend API работает на `http://localhost:8000`.
*   Backend настроен с CORS для разрешения запросов с `http://localhost:3000` (и других распространенных портов разработки, или `*` для открытого доступа во время разработки).
*   Компонент `LoginPage.tsx` во frontend делает `POST` запрос к `http://localhost:8000/api/v1/auth/token` для аутентификации.
*   Компонент `AdminPage.tsx` во frontend делает запросы к:
    *   `POST http://localhost:8000/api/v1/users/` для создания пользователей.
    *   `GET http://localhost:8000/api/v1/users/me/` для получения данных текущего пользователя (как заглушка для полного списка пользователей, в то время как `GET /api/v1/users/` ожидается для получения полного списка пользователей).
*   Для раздела **Заказы** в `AdminPage.tsx`, можно начать интеграцию со следующими эндпоинтами backend:
    *   `GET http://localhost:8000/api/v1/orders/` для получения списка заказов (требует аутентификации).
    *   `GET http://localhost:8000/api/v1/orders/{order_id}` для получения конкретного заказа (требует аутентификации).
    *   `PUT http://localhost:8000/api/v1/orders/{order_id}/status` для обновления статуса заказа (требует аутентификации администратора).
    *   `POST http://localhost:8000/api/v1/orders/` для создания новых заказов (текущая реализация не требует аутентификации, так как рассчитана на Telegram бота; для использования администратором может потребоваться доработка или отдельный эндпоинт/проверка прав).

## Дальнейшая разработка и задачи

### Frontend:
*   Реализовать API вызовы для всех CRUD операций на странице администратора:
    *   **Заказы**: Интегрирован просмотр списка заказов (`GET /api/v1/orders/`), просмотр деталей заказа (`GET /api/v1/orders/{order_id}`) и обновление статуса заказа (`PUT /api/v1/orders/{order_id}/status`). Создание заказов (`POST /api/v1/orders/`) требует дальнейшего рассмотрения с учетом текущей логики аутентификации эндпоинта.
    *   **Меню**: CRUD операции интегрированы.
    *   **Локации**: Интегрировано получение списка локаций (`GET /api/v1/locations/`) и их удаление (`DELETE /api/v1/locations/{location_id}`). Создание и редактирование локаций требует дальнейшей реализации.
*   Mock данные заменены на данные с бэкенда для разделов "Пользователи", "Редактирование меню", "Текущие заказы" и "Масштабирование (список локаций)".
*   Реализовать правильную обработку ошибок и состояний загрузки для всех API взаимодействий (частично сделано).
*   Разработать страницу клиентского приложения.
*   Добавить функциональность редактирования и удаления пользователей.
*   Защита маршрутов администратора временно отключена (`SKIP_ADMIN_LOGIN=true` в `.env`) для тестирования. Необходимо будет восстановить и проверить.
*   Реализована функциональность выхода из системы.

### Backend:
*   Реализован `GET /api/v1/users/` для получения списка всех пользователей (защищено для администратора).
*   Реализовать `PUT /api/v1/users/{user_id}` и `DELETE /api/v1/users/{user_id}` для управления пользователями.
*   Полностью реализовать CRUD операции для endpoints `locations` и `menu_items`. Эндпоинты для `orders` частично реализованы и готовы к интеграции (см. задачи Frontend).
*   Рассмотреть необходимость аутентификации для `POST /api/v1/orders/` при использовании из админ-панели.
*   Улучшить взаимодействие с базой данных (сейчас JSON файлы, рассмотреть более надежную базу данных как PostgreSQL или SQLite для продакшена).
*   Добавить более комплексные тесты.
*   Улучшить безопасность, особенно для продакшена (например, более специфичные CORS источники).

Этот `README.md` предоставляет общий обзор. Для более конкретных деталей обратитесь к файлам `README.md` в директориях `aeroclub-app` и `backend`.

## Клиентское приложение (`client-app`)

Это React-приложение (также на Create React App и TypeScript), предназначенное для работы как **Telegram Mini App**.

### Настройка для Telegram
*   В `public/index.html` добавлен скрипт `telegram-web-app.js`, необходимый для интеграции с Telegram.
*   Приложение настроено для отображения одного компонента — `ClientAppPage`, который станет основой для интерфейса в Telegram.

### Установка и запуск
1.  **Перейдите в директорию:**
    ```bash
    cd aeroclub/client-app
    ```
2.  **Установите зависимости:**
    ```bash
    npm install
    ```
3.  **Запустите сервер разработки:**
    ```bash
    npm start
    ```
    Приложение будет доступно по адресу `http://localhost:3001` (или другому порту, если 3000 занят).

### Как открыть в Telegram
1.  **Запустите приложение локально**, как описано выше.
2.  **Используйте ngrok** или аналогичный сервис, чтобы создать публичный HTTPS-тоннель к вашему локальному серверу (`localhost:3001`).
    ```bash
    ngrok http 3001
    ```
3.  **Настройте своего Telegram-бота**: через [@BotFather](https://t.me/BotFather) установите URL вашего Mini App, используя полученную HTTPS-ссылку от ngrok.
4.  **Откройте приложение в Telegram**: Перейдите в чат с вашим ботом и откройте Mini App через меню или по прямой ссылке.

## Быстрый запуск

Для запуска всего проекта выполните следующие шаги:

1.  **Запустите Backend:**
    ```bash
    cd aeroclub/backend
    # (следуйте инструкциям по установке и запуску выше)
    uvicorn app.main:app --host 0.0.0.0 --reload
    ```

2.  **Запустите Панель администратора:**
    ```bash
    cd aeroclub/admin-app
    npm install
    npm start
    ```

3.  **Запустите Клиентское приложение:**
    ```bash
    cd aeroclub/client-app
    npm install
    npm start
    ```

После запуска сервисы будут доступны по следующим адресам:
-   **Backend API**: `http://localhost:8000`
-   **API документация**: `http://localhost:8000/docs`
-   **Панель администратора**: `http://localhost:3000`
-   **Клиентское приложение**: `http://localhost:3001`
