# Система логирования транзакций партнеров

## Обзор

Реализована система автоматического списания $25 с баланса партнера за каждую обработанную заявку через API, с полным логированием транзакций и партнерским порталом для просмотра.

## Новые функции

### 1. Автоматическое списание средств
- При получении заявки через API автоматически списывается $25 с баланса партнера
- Стоимость настраивается через константу `LEAD_PROCESSING_COST_USD` в `config.php`
- Проверка достаточности средств перед обработкой заявок
- Обновление статуса транзакции при получении отчета от Zeno

### 2. Полное логирование транзакций
- Сохранение всех данных заявки от партнера
- Статус транзакции (charged, pending, completed, failed)
- Баланс партнера до и после списания
- Детали выполнения (сумма платежа, валюта, email клиента и т.д.)
- Временные метки создания и обновления

### 3. Партнерский портал
**URL:** `/amogt/gpt_payment_api/partner_portal/`

#### Возможности портала:
- **Аутентификация по API токену** - партнеры входят используя свой API токен
- **Дашборд с статистикой**:
  - Текущий баланс
  - Общее количество заявок
  - Количество успешных/неуспешных обработок
  - Финансовая статистика
- **Список всех транзакций** с фильтрацией по статусу
- **Детальный просмотр каждой транзакции** включая данные заявки
- **API документация** с примерами интеграции

### 4. Административная панель
**URL:** `/amogt/gpt_payment_api/admin/partner_transactions.php`

#### Новые возможности для админа:
- Просмотр всех транзакций партнеров
- Фильтрация по партнерам
- Статистика по каждому партнеру
- Детальный просмотр данных заявок
- Интеграция с существующим дашбордом

## API изменения

### Новый эндпоинт: get_transactions
```
GET /amogt/gpt_payment_api/api.php?action=get_transactions&api_token=YOUR_TOKEN&limit=100
```

Возвращает список транзакций партнера с полной информацией.

### Обновленный submit_partner_lead
- Теперь проверяет баланс перед обработкой
- Списывает $25 за каждую заявку
- Возвращает код 402 при недостатке средств
- Логирует полную информацию о транзакции

## Структура данных транзакции

```json
{
  "transaction_id": "lead_txn_669...",
  "partner_id": "partner_123",
  "partner_name": "Партнер 1",
  "lead_id": "lead_456",
  "partner_deal_id": "deal_789",
  "charge_amount_usd": 25,
  "partner_balance_before": 100.00,
  "partner_balance_after": 75.00,
  "lead_data_received": {
    "dealId": "deal_789",
    "paymentUrl": "https://stripe.com/...",
    "customerName": "Иван Иванов",
    "customerEmail": "ivan@example.com"
  },
  "status": "completed",
  "created_at": "2025-07-02 15:30:00",
  "updated_at": "2025-07-02 15:35:00",
  "completion_status": "Выполнено",
  "completion_details": {
    "status": "Выполнено",
    "amount": "1000",
    "currency": "RUB",
    "email": "ivan@example.com",
    "report_id": "zenorep_..."
  }
}
```

## Файлы системы

### Новые файлы:
- `gpt_payment_api/lib/partner_transaction_logger.php` - Класс для работы с транзакциями
- `gpt_payment_api/admin/partner_transactions.php` - Админская страница транзакций
- `gpt_payment_api/partner_portal/` - Полный партнерский портал
  - `index.php` - Главный файл портала
  - `auth.php` - Аутентификация партнеров
  - `templates/` - Шаблоны интерфейса

### Модифицированные файлы:
- `config.php` - Добавлена константа `LEAD_PROCESSING_COST_USD`
- `gpt_payment_api/api.php` - Добавлено списание средств и новый эндпоинт
- `zeno_report.php` - Добавлено обновление статуса транзакций
- `gpt_payment_api/admin/templates/dashboard.php` - Добавлена ссылка на портал

## База данных

### Новая таблица: partner_lead_transactions.json
Хранит все транзакции партнеров с полной информацией о заявках и их обработке.

## Использование

### Для партнеров:
1. Получить API токен от администратора
2. Зайти в партнерский портал: `/amogt/gpt_payment_api/partner_portal/`
3. Войти используя API токен
4. Просматривать статистику и транзакции
5. Использовать API документацию для интеграции

### Для администраторов:
1. Просматривать все транзакции в админке
2. Отслеживать статистику по партнерам
3. Проверять корректность списаний
4. Управлять балансами партнеров

## Безопасность

- Партнеры аутентифицируются только по API токену
- Каждый партнер видит только свои транзакции
- Админы имеют полный доступ ко всем данным
- Логирование всех операций для аудита

## Мониторинг

Все операции логируются в:
- `logs_*/submit_partner_lead.log` - API операции
- `logs_*/zeno_report_*.log` - Отчеты по конкретным лидам
- Стандартное логирование системы
