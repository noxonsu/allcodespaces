# API для Оплаты ChatGPT и Обработки Лидов через Партнеров

Этот документ описывает API, предназначенное для интеграции с внешними партнерами, позволяя им использовать внутренние разработки для проведения оплат ChatGPT и отправки лидов на обработку, а также для операторов для отправки отчетов по лидам.

## Обзор

API предоставляет следующие основные возможности:
1.  **Аутентификация и идентификация партнеров** по уникальному API токену.
2.  **Управление балансом партнеров**: просмотр текущего баланса.
3.  **Расчет стоимости платежа**: определение стоимости платежа в валюте баланса партнера на основе актуальных курсов.
4.  **Проведение платежей**: списание средств с баланса партнера для оплаты услуг.
5.  **Отслеживание статуса транзакций**.
6.  **Прием лидов от партнеров**: получение данных от партнеров для дальнейшей обработки (интегрировано в основной API платежей).
7.  **Прием отчетов по лидам (Zeno Report)**: эндпоинт для операторов для отправки результатов обработки лидов.

Административная панель позволяет управлять партнерами, их балансами и курсами валют.

## Структура Папок (Основные)

*   `/amogt/gpt_payment_api/`
    *   `api.php`: Главный файл API, обрабатывающий все входящие запросы, связанные с платежами и приемом лидов от партнеров.
    *   `admin/`: Директория с файлами административной панели.
    *   `lib/`: Вспомогательные PHP классы и функции для платежного API.
*   `/amogt/`
    *   `amo2json.php`: Вебхук для приема лидов из AmoCRM.
    *   `zeno_report.php`: Эндпоинт для приема отчетов по лидам от операторов.
    *   `lib/`: Общие библиотеки (`json_storage_utils.php`, `request_utils.php`).
    *   `data/`:
        *   `allLeads.json`: Основной файл для хранения данных лидов (из AmoCRM и от партнеров).
        *   `recieved_api_ids.txt`: Хранит ID лидов, полученных от партнеров (для предотвращения дублей).
        *   `recieved_amo_ids.txt`: Хранит ID сделок AmoCRM, по которым уже был отправлен отчет/обновление (для предотвращения дублей).
        *   `zeno_report.json`: Хранит отчеты, отправленные через `zeno_report.php`.
    *   `logs/`: Директория для лог-файлов.


## Конфигурация

Основные настройки API и админки должны быть заданы в файле `.env` в корневой директории `amogt/`.
*   `GPT_ADMIN_USERNAME`, `GPT_ADMIN_PASSWORD_HASH`
*   Настройки AmoCRM (`AMO_DOMAIN`, `AMO_INTEGRATION_ID` и т.д.)
*   Прочие настройки, как указано в `config.php`.

## Общая схема работы с лидами

Лиды в системе могут поступать из двух источников и обрабатываются следующим образом:

1.  **Лиды из AmoCRM**:
    *   Поступают через вебхук на скрипт `amogt/amo2json.php`.
    *   Данные о лиде (включая `dealId` и `paymentUrl`) сохраняются в основной файл данных лидов: `amogt/allLeads.json`.
    *   Этот файл используется для дальнейшей обработки и отображения.

2.  **Лиды от Партнеров**:
    *   Поступают через основной API `amogt/gpt_payment_api/api.php` с `action=submit_partner_lead`.
    *   Партнер передает массив лидов, каждый из которых должен содержать `dealId` (уникальный ID лида со стороны партнера).
    *   Перед сохранением, `dealId` каждого лида проверяется на дубликат в файле `amogt/recieved_api_ids.txt`. Если ID уже существует, лид пропускается. Новые ID добавляются в этот файл.
    *   Данные успешно принятых лидов (с добавлением `partnerId` и `partner_name` на основе API токена) также сохраняются в основной файл `amogt/allLeads.json`.

3.  **Обработка лидов и Отчетность (Операторы/Zeno)**:
    *   Система автоматизации (например, Zeno) получает список лидов для обработки из `amogt/amodeals_json.php`.
    *   После выполнения работы по лиду, система автоматизации (или оператор вручную) отправляет отчет через эндпоинт `amogt/zeno_report.php`.
    *   **Параметры `zeno_report.php`**:
        *   `GET id={lead_id}`: Где `{lead_id}` - это `dealId` из `allLeads.json`.
        *   `POST data`: Включает `status` ("Успешно" или "ОШИБКА!"), опциональные поля (`amount`, `currency`, `email`, `card`) и опциональный `partner_id`.
    *   **Логика `zeno_report.php`**:
        *   Все отчеты сохраняются в `amogt/zeno_report.json`.
        *   Если в POST-запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
        *   Если `partner_id` **отсутствует**:
            *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
            *   Если `lead_id` новый, он добавляется в `recieved_amo_ids.txt`.
            *   Производится поиск сделки в AmoCRM по `lead_id`.
            *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `recieved_amo_ids.txt` служат для предотвращения дублирующей обработки и обновлений.

## Эндпоинты API

### Основной API Партнеров (Платежи и Прием Лидов)

Все запросы к этому API должны отправляться на `ваш_домен/amogt/gpt_payment_api/api.php`.
Метод передачи параметров: `GET` или `POST` (для `submit_partner_lead` - `POST` с JSON телом).
Формат ответа: JSON.

#### Общие параметры для большинства запросов (если не указано иное):
*   `api_token` (string, required): Уникальный API токен партнера. Передается как GET/POST параметр, либо в JSON теле для `submit_partner_lead`.

#### 1. Получение баланса партнера
*   **Action**: `get_balance`
    *   ... (описание без изменений) ...

#### 2. Получение стоимости платежа
*   **Action**: `get_payment_cost`
    *   ... (описание без изменений) ...

#### 3. Проведение платежа
*   **Action**: `process_payment`
    *   ... (описание без изменений) ...

#### 4. Получение статуса транзакции
*   **Action**: `get_transaction_status`
    *   ... (описание без изменений) ...

#### 5. Отправка лидов от партнера (пакетная)
*   **Action**: `submit_partner_lead`
*   **Метод**: `POST`
*   **Формат запроса**: JSON (тело запроса)
*   **Параметры (в теле JSON-запроса)**:
    *   `action` (string, required): Должен быть `"submit_partner_lead"`.
    *   `api_token` (string, required): Уникальный API токен партнера.
    *   `lead_data` (array, required): Массив JSON-объектов, где каждый объект представляет лид. Каждый лид должен содержать как минимум `dealId`. Другие поля (`paymentUrl`, `created_at`, `last_updated`, пользовательские поля) также могут быть включены. `partnerId` и `partner_name` будут добавлены/перезаписаны сервером. Лиды с `dealId`, уже существующими в `recieved_api_ids.txt`, будут проигнорированы. Новые `dealId` добавляются в `recieved_api_ids.txt`, а сами данные лида - в `allLeads.json`.
*   **Пример тела запроса**:
    ```json
    {
        "action": "submit_partner_lead",
        "api_token": "ВАШ_API_ТОКЕН",
        "lead_data": [
            {
                "dealId": "partner_deal_001",
                "paymentUrl": "https://example.com/pay/1",
                "custom_info": "Детали по лиду 1"
            },
            {
                "dealId": "partner_deal_002",
                "some_other_field": "еще данные"
            }
        ]
    }
    ```
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Processed X leads. Added to main list: Y, Updated in main list: Z.",
        "processed_count": X,
        "added_to_main_list_count": Y,
        "updated_in_main_list_count": Z,
        "errors": [] // Массив ошибок, если какие-то лиды не удалось обработать или были дублями
    }
    ```
*   **Ошибки**: 400, 401, 405, 429, 500.

## Инструкция для Zeno автоматизации (и других систем обработки лидов)

Этот раздел описывает, как внешние системы автоматизации (например, Zeno) должны взаимодействовать с API для получения списка задач (лидов) и отправки отчетов об их выполнении.

### 1. Получение списка активных лидов (задач)

Для получения полного списка текущих лидов, которые требуют обработки, система автоматизации должна выполнить GET-запрос к следующему эндпоинту:

*   **URL**: `https://ваш_домен/amogt/amodeals_json.php` (без параметров)
*   **Метод**: `GET`
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "deals": [
            {
                "dealId": "14252569",
                "paymentUrl": "https://pay.openai.com/...",
                "created_at": "2025-06-09 08:47:02",
                "last_updated": "2025-06-09 08:47:02",
                "partnerId": "partner_id_если_есть", // Поле будет присутствовать, если лид от партнера
                "partner_name": "Имя партнера если есть" 
                // ... другие поля, которые были сохранены для лида ...
            },
            // ... другие лиды
        ],
        "total": X, // Общее количество лидов
        "message": "Current deals in JSON file.",
        "info": { ... } // Дополнительная информация об использовании скрипта
    }
    ```
*   **Примечание**: Система автоматизации должна сама определить, какие из полученных лидов являются "новыми" или "необработанными" (например, сравнивая с ранее полученными ID или проверяя наличие отчета в `zeno_report.json`).

### 2. Отправка отчета о выполнении задачи

После выполнения работы по лиду, система автоматизации отправляет отчет через следующий эндпоинт:

*   **URL**: `https://ваш_домен/amogt/zeno_report.php?id={lead_id}`
    *   `{lead_id}`: ID лида (соответствует `dealId` из файла `allLeads.json`).
*   **Метод**: `POST`
*   **Формат запроса**: `application/x-www-form-urlencoded` или `multipart/form-data`.
*   **Параметры (в теле POST-запроса)**:
    *   `status` (string, required): Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
    *   `amount` (string, optional): Сумма (если применимо).
    *   `currency` (string, optional): Валюта (если применимо).
    *   `email` (string, optional): Email (если применимо).
    *   `card` (string, optional): Карта (если применимо).
    *   `partner_id` (string, optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
    *   *Любые другие поля, которые система автоматизации хочет передать в отчете.*
*   **Логика на стороне сервера (`zeno_report.php`)**:
    1.  Отчет сохраняется в `amogt/zeno_report.json`.
    2.  Если `partner_id` **не передан**:
        *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
        *   Если не обработан, `lead_id` добавляется в `recieved_amo_ids.txt`.
        *   Производится поиск сделки в AmoCRM по `lead_id`.
        *   Если сделка найдена и ее поле "Статус оплаты ChatGPT" (или аналогичное настроенное поле) пустое:
            *   Обновляются поля сделки в AmoCRM на основе переданных данных и некоторых статических значений (например, "Администратор: Бот Zeno").
            *   Если `status` из POST-запроса не "ОШИБКА!", сделка переводится на этап "Финальный Операторский" в AmoCRM.
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Report received and processed.",
        "report_id": "zenorep_xxxxxxxxxxxx", // Уникальный ID этого отчета
        "lead_id": "xxxxxxx", // ID лида, по которому отчет
        "amo_status": "success/failed/skipped", // Статус операции с AmoCRM
        "amo_message": "Сообщение об операции с AmoCRM"
    }
    ```
*   **Ошибки (ответ сервера)**: 400, 405, 500.

## Административная панель
    *   ... (описание без изменений) ...

## Безопасность
    *   ... (описание без изменений) ...

## Дальнейшая разработка
    *   ... (описание без изменений) ...
