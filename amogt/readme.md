# Интеграция AMO CRM и Google Таблиц

Этот скрипт на Node.js обеспечивает интеграцию AMO CRM с Google Таблицами для двух задач:
1.  **Задача 1**: Передача полей «Номер сделки» и «Ссылка на оплату» из AMO CRM в Google Таблицу при нажатии кнопки «Сохранить» (требует настройки вебхука).
2.  **Задача 2**: Чтение новых строк из Google Таблицы и обновление соответствующих сделок в AMO CRM с полями: Сумма, Валюта, Почта, Карта, Статус и статическими значениями.

## Требования
- Node.js (версия 16 или выше)
- Проект в Google Cloud с включенным API Google Таблиц
- Аккаунт AMO CRM с доступом к API
- Google Таблица с правильной структурой
- Базовые знания работы с переменными окружения и командной строкой

## Инструкция по настройке

### 1. Установка зависимостей
Склонируйте репозиторий или скопируйте файлы проекта. Установите необходимые пакеты Node.js:

```bash
npm init -y
npm install axios dotenv googleapis express # express если используется вебхук-сервер
```

### 2. Настройка Google Таблиц API
Для работы с Google Таблицами нужны `SPREADSHEET_ID_AMO2GT`, `SPREADSHEET_ID_GT2AMO`, `SHEET_NAME` и файл ключей сервисного аккаунта.

#### Получение `SPREADSHEET_ID`
1.  Создайте две Google Таблицы или два листа в одной таблице: один для Задачи 1 (AMO -> GTable) и один для Задачи 2 (GTable -> AMO).
2.  `SPREADSHEET_ID` — это длинная строка в URL таблицы. Например, в:
    ```
    https://docs.google.com/spreadsheets/d/1aBcDeFgHiJkLmNoPqRsTuVwXyZ/edit
    ```
    `SPREADSHEET_ID` — это `1aBcDeFgHiJkLmNoPqRsTuVwXyZ`.
3.  Скопируйте эти ID для файла `.env` как `SPREADSHEET_ID_AMO2GT` и `SPREADSHEET_ID_GT2AMO`.

#### Получение `SHEET_NAME`
1.  Откройте Google Таблицу.
2.  `SHEET_NAME` — это название конкретного листа (вкладки) в таблице (например, «Sheet1»). Если вы используете разные листы для Задач 1 и 2, убедитесь, что они правильно настроены. Скрипт использует `SHEET_NAME` из `.env` как имя листа по умолчанию.
3.  Убедитесь, что структура листа соответствует задачам:
    -   Для **Задачи 1** (лист для `SPREADSHEET_ID_AMO2GT`): минимум два столбца (A — Номер сделки, B — Ссылка на оплату).
    -   Для **Задачи 2** (лист для `SPREADSHEET_ID_GT2AMO`): минимум семь столбцов (A: Номер сделки, B: Ссылка на оплату (не используется для обновления), C: Сумма, D: Валюта, E: Почта, F: Карта, G: Статус).
4.  Скопируйте точное название листа для файла `.env` (если отличается от "Sheet1").

#### Настройка файла ключей Google (`mycity2_key.json`)
1.  Перейдите в [Google Cloud Console](https://console.cloud.google.com/).
2.  Создайте новый проект или выберите существующий.
3.  Включите **Google Sheets API**:
    -   Перейдите в «APIs & Services» > «Library».
    -   Найдите «Google Sheets API» и нажмите «Enable».
4.  Создайте учетные данные:
    -   Перейдите в «APIs & Services» > «Credentials».
    -   Нажмите «Create Credentials» > «Service Account».
    -   Заполните данные и создайте сервисный аккаунт.
    -   Скачайте JSON-файл ключей. **Переименуйте этот файл в `mycity2_key.json` и поместите его в корень проекта.**
5.  Предоставьте доступ сервисному аккаунту:
    -   Откройте JSON-файл (`mycity2_key.json`) и найдите `client_email` (например, `service-account@project.iam.gserviceaccount.com`).
    -   В каждой Google Таблице, которую будет использовать скрипт, нажмите «Поделиться» и добавьте этот email с правами «Редактор».

### 3. Настройка AMO CRM API
Для работы с AMO CRM используются OAuth 2.0. Вам понадобятся `AMO_DOMAIN`, `AMO_INTEGRATION_ID`, `AMO_SECRET_KEY`. При первом запуске также потребуется `AMO_AUTH_CODE`.

#### Получение `AMO_DOMAIN`
1.  Войдите в свой аккаунт AMO CRM.
2.  `AMO_DOMAIN` — это полный домен вашего экземпляра AMO CRM (например, `https://yourcompany.amocrm.ru` или `https://yourcompany.amocrm.com`).
3.  Скопируйте этот URL для файла `.env`.

#### Получение `AMO_INTEGRATION_ID` и `AMO_SECRET_KEY`
1.  В AMO CRM перейдите в «Настройки» (или amoMarket -> три точки -> Создать интеграцию).
2.  Создайте новую интеграцию типа "Внешний сервис" (oAuth 2.0).
    -   Укажите название, описание.
    -   В качестве "Ссылка для перенаправления" (Redirect URI) укажите URL, который будет обрабатывать ответ AmoCRM. **Этот URL должен быть точно таким же, как значение, которое вы укажете для `AMO_REDIRECT_URI` в вашем `.env` файле.** Например, `https://yourcompany.amocrm.ru` (если ваш сервер не обрабатывает специальный путь для редиректа) или другой настроенный вами URL.
    -   Предоставьте необходимые доступы (чтение/запись сделок).
3.  После создания интеграции вы получите `ID интеграции` и `Секретный ключ`. Скопируйте их в файл `.env` как `AMO_INTEGRATION_ID` и `AMO_SECRET_KEY`.

#### Получение `AMO_AUTH_CODE` (для первого запуска)
1.  После настройки `.env` с `AMO_INTEGRATION_ID`, `AMO_SECRET_KEY`, `AMO_DOMAIN`, запустите скрипт.
2.  Он выведет в консоль URL для получения кода авторизации. Перейдите по этому URL в браузере.
3.  Авторизуйтесь в AmoCRM и разрешите доступ приложению.
4.  Вы будете перенаправлены на указанный `redirect_uri` (ваш `AMO_DOMAIN`). В адресной строке браузера найдите параметр `code=АВТОРИЗАЦИОННЫЙ_КОД`.
5.  Скопируйте этот `АВТОРИЗАЦИОННЫЙ_КОД` и вставьте его в файл `.env` как `AMO_AUTH_CODE`.
6.  Перезапустите скрипт. Он использует этот код для получения access/refresh токенов и сохранит их в `amo_tokens.json`. После этого `AMO_AUTH_CODE` из `.env` больше не нужен для последующих запусков, пока токены действительны.

### 4. Настройка пользовательских полей в AMO CRM
Скрипт обновляет пользовательские поля в AMO CRM для **Задачи 2**. Создайте эти поля в AMO CRM и запишите их ID.
- Сумма выдана
- Валюта
- Счет списания
- Дата списания
- Администратор
- Карта
- Оплаченный сервис
- Почта
- Срок оплаты
- Статус

Чтобы найти ID полей:
1.  Перейдите в AMO CRM в «Настройки» > «Поля» (для сделок).
2.  Создайте или найдите нужные поля. ID поля можно увидеть, например, при редактировании поля или через API.
3.  Обновите соответствующие переменные в файле `.env` (например, `AMO_FIELD_AMOUNT_ISSUED=ВАШ_FIELD_ID`). См. примеры в `config.js` для имен переменных.

### 5. Настройка переменных окружения
Создайте файл `.env` в корне проекта. Все переменные загружаются через `config.js`. **Этот файл `.env` не является исполняемым скриптом.**

Пример `.env` файла:
```env
# Это конфигурационный файл, не запускайте его с помощью node!
# Настройки Google Таблиц
SPREADSHEET_ID_AMO2GT=ВАШ_ID_ТАБЛИЦЫ_ДЛЯ_AMO_В_GTABLES
SPREADSHEET_ID_GT2AMO=ВАШ_ID_ТАБЛИЦЫ_ДЛЯ_GTABLES_В_AMO
SHEET_NAME=Sheet1 # Имя листа по умолчанию, если не указано иное

# Настройки AMO CRM (OAuth 2.0)
AMO_DOMAIN=https://yourcompany.amocrm.ru
AMO_INTEGRATION_ID=ВАШ_ID_ИНТЕГРАЦИИ
AMO_SECRET_KEY=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ
AMO_REDIRECT_URI=https://yourcompany.amocrm.ru # ВАЖНО: Должен точно совпадать с указанным в настройках интеграции AmoCRM
AMO_AUTH_CODE= # Вставьте сюда код авторизации при первом запуске

# ID Пользовательских полей AMO CRM (для Задачи 2)
AMO_FIELD_AMOUNT_ISSUED=100001
AMO_FIELD_CURRENCY=100002
AMO_FIELD_WITHDRAWAL_ACCOUNT=100003
AMO_FIELD_WITHDRAWAL_DATE=100004
AMO_FIELD_ADMINISTRATOR=100005
AMO_FIELD_CARD=100006
AMO_FIELD_PAID_SERVICE=100007
AMO_FIELD_EMAIL=100008
AMO_FIELD_PAYMENT_TERM=100009
AMO_FIELD_STATUS=100010

# Опционально, для gtables2amo.js, если используется прямой токен вместо OAuth для этого модуля
# AMO_TOKEN=ВАШ_ПРЯМОЙ_API_ТОКЕН_ЕСЛИ_ИСПОЛЬЗУЕТСЯ

# Опционально
# NAMEPROMPT=имя_вашего_проекта
```

### 6. Запуск скрипта
**Важно:** Убедитесь, что вы запускаете скрипт `allcdsps-amogtindex.js`, а не какой-либо другой файл (например, не `.env`).

1.  Убедитесь, что все зависимости установлены, файл `mycity2_key.json` на месте, и файл `.env` настроен.
2.  Установите PM2, если еще не установлен:
    ```bash
    npm install -g pm2
    ```
3.  Запустите главный скрипт с помощью PM2 (рекомендуется):
    ```bash
    pm2 start allcdsps-amogtindex.js --name amocrm-gtables-sync
    ```
    Или напрямую с помощью Node.js:
    ```bash
    node allcdsps-amogtindex.js
    ```
4.  Скрипт будет:
    -   Ожидать обновления из AMO CRM (для Задачи 1 требуется настройка вебхука; см. ниже).
    -   Периодически проверять Google Таблицу (`SPREADSHEET_ID_GT2AMO`) на наличие новых строк и обновлять AMO CRM (Задача 2).

### 7. Настройка вебхука для Задачи 1
Модуль `amo2gtables.js` содержит функцию `handleAmoWebhook` и `startAmoWebhookListener`. Для полной реализации Задачи 1:
1.  Вам нужно реализовать HTTP-сервер (например, с использованием Express, как показано в `allcdsps-amogtindex.js`, если вы решите его там разместить, или в отдельном файле).
2.  В AMO CRM настройте вебхук (Настройки -> Интеграции -> Ваша интеграция -> Вебхуки), чтобы отправлять обновления сделок (например, при изменении статуса или сохранении) на URL вашего сервера (например, `https://ваш-сервер.com/webhook`).
3.  Измените `handleAmoWebhook` для обработки полезной нагрузки вебхука и извлечения `deal_number` и `payment_link`.

Пример настройки Express сервера (можно интегрировать в `allcdsps-amogtindex.js` или запустить отдельно):
```javascript
// В allcdsps-amogtindex.js или отдельном файле
const express = require('express');
const { handleAmoWebhook } = require('./amo2gtables'); // Убедитесь, что путь правильный

function setupWebhookServer() {
    const app = express();
    const port = process.env.PORT || 3000; // Порт из .env или по умолчанию
    app.use(express.json());

    app.post('/webhook', async (req, res) => {
        console.log('Webhook received:', req.body);
        // Здесь вам нужно адаптировать req.body к формату, ожидаемому handleAmoWebhook
        // Например, если AmoCRM отправляет данные о сделке в req.body.leads.update[0]
        // const dealData = req.body.leads.update[0]; // Это пример, проверьте формат AmoCRM
        // await handleAmoWebhook(dealData); 
        // handleAmoWebhook ожидает { deal_number: ..., payment_link: ... }
        // Вам нужно будет извлечь эти данные из фактической структуры вебхука AmoCRM
        res.status(200).send('OK');
    });

    app.listen(port, () => {
        console.log(`Сервер вебхуков запущен на порту ${port}`);
    });
}

// Вызовите setupWebhookServer() в функции main() вашего allcdsps-amogtindex.js
// или запустите этот сервер как отдельный процесс.
```

### Устранение неполадок
-   **Ошибки Google Sheets API**: Проверьте правильность `SPREADSHEET_ID_...`, `SHEET_NAME` в `.env` и наличие `mycity2_key.json`. Убедитесь, что сервисный аккаунт (email из `mycity2_key.json`) имеет права редактора для таблиц.
-   **Ошибки AMO CRM API**: Проверьте `AMO_DOMAIN`, `AMO_INTEGRATION_ID`, `AMO_SECRET_KEY` в `.env`. При первом запуске убедитесь, что `AMO_AUTH_CODE` был правильно получен и введен. Проверьте `amo_tokens.json` на наличие токенов.
-   **Ошибки пользовательских полей**: Убедитесь, что все ID полей `AMO_FIELD_...` в `.env` совпадают с ID в AMO CRM.
-   **Проблемы с вебхуком**: Убедитесь, что ваш сервер вебхуков общедоступен (например, через ngrok для локального тестирования), и URL вебхука правильно настроен в AMO CRM. Проверьте логи сервера на получение запросов.

### Примечания
-   Скрипт выполняет Задачу 2 (синхронизация из Google Таблиц в AMO) с интервалом, заданным в `gtables2amo.js` (по умолчанию 1 минута).
-   Защитите файл `.env` и `mycity2_key.json`, так как они содержат конфиденциальную информацию.
-   Для продакшена разверните скрипт на сервере и используйте PM2 для управления процессами.

Для дополнительной информации:
- [Документация Google Sheets API](https://developers.google.com/sheets/api)
- [Документация AMO CRM API](https://www.amocrm.ru/developers/content/api/auth) (для oAuth)