# Интеграция AMO CRM и Google Таблиц

Этот скрипт на Node.js обеспечивает интеграцию AMO CRM с Google Таблицами для двух задач:
1. **Задача 1**: Передача полей «Номер сделки» и «Ссылка на оплату» из AMO CRM в Google Таблицу при нажатии кнопки «Сохранить».
2. **Задача 2**: Чтение новых строк из Google Таблицы и обновление соответствующих сделок в AMO CRM с полями: Сумма, Валюта, Почта, Карта, Статус и статическими значениями (например, «Mastercard Prepaid», «chatgpt»).

## Требования
- Node.js (версия 16 или выше)
- Проект в Google Cloud с включенным API Google Таблиц
- Аккаунт AMO CRM с доступом к API
- Google Таблица с правильной структурой
- Базовые знания работы с переменными окружения и командной строкой

## Инструкция по настройке

### 1. Установка зависимостей
Склонируйте репозиторий или скопируйте скрипт (`gtables2amo.js`) в директорию проекта. Установите необходимые пакеты Node.js:

```bash
npm init -y
npm install axios dotenv googleapis
```

### 2. Настройка Google Таблиц API
Для работы с Google Таблицами нужны `SPREADSHEET_ID`, `SHEET_NAME` и `GOOGLE_CREDENTIALS`.

#### Получение `SPREADSHEET_ID`
1. Создайте новую Google Таблицу или откройте существующую.
2. `SPREADSHEET_ID` — это длинная строка в URL таблицы. Например, в:
   ```
   https://docs.google.com/spreadsheets/d/1aBcDeFgHiJkLmNoPqRsTuVwXyZ/edit
   ```
   `SPREADSHEET_ID` — это `1aBcDeFgHiJkLmNoPqRsTuVwXyZ`.
3. Скопируйте этот ID для файла `.env`.

#### Получение `SHEET_NAME`
1. Откройте Google Таблицу.
2. `SHEET_NAME` — это название конкретного листа (вкладки) в таблице, отображаемое внизу (например, «Sheet1»).
3. Убедитесь, что структура листа соответствует задачам:
   - Для **Задачи 1**: минимум два столбца (A — Номер сделки, B — Ссылка на оплату).
   - Для **Задачи 2**: минимум семь столбцов (A: Номер сделки, B: Ссылка на оплату, C: Сумма, D: Валюта, E: Почта, F: Карта, G: Статус).
4. Скопируйте точное название листа для файла `.env`.

#### Получение `GOOGLE_CREDENTIALS`
1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/).
2. Создайте новый проект или выберите существующий.
3. Включите **Google Sheets API**:
   - Перейдите в «APIs & Services» > «Library».
   - Найдите «Google Sheets API» и нажмите «Enable».
4. Создайте учетные данные:
   - Перейдите в «APIs & Services» > «Credentials».
   - Нажмите «Create Credentials» > «Service Account».
   - Заполните данные и создайте сервисный аккаунт.
   - Скачайте JSON-файл ключей (например, `credentials.json`).
5. Предоставьте доступ сервисному аккаунту:
   - Откройте JSON-файл и найдите `client_email` (например, `service-account@project.iam.gserviceaccount.com`).
   - В Google Таблице нажмите «Поделиться» и добавьте этот email с правами «Редактор».
6. Скопируйте весь JSON из файла ключей для файла `.env`.

### 3. Настройка AMO CRM API
Для работы с AMO CRM нужны `AMO_DOMAIN` и `AMO_TOKEN`.

#### Получение `AMO_DOMAIN`
1. Войдите в свой аккаунт AMO CRM.
2. `AMO_DOMAIN` — это поддомен вашего экземпляра AMO CRM. Например, если URL AMO CRM:
   ```
   https://mycompany.amocrm.com
   ```
   `AMO_DOMAIN` — это `mycompany`.
3. Скопируйте поддомен для файла `.env`.

#### Получение `AMO_TOKEN`
1. В AMO CRM перейдите в «Настройки» > «Интеграции».
2. Создайте новую интеграцию или используйте существующую для генерации API-токена.
3. Скопируйте токен для файла `.env`.
4. Убедитесь, что интеграция имеет права на чтение и запись сделок.

### 4. Настройка пользовательских полей в AMO CRM
Скрипт обновляет пользовательские поля в AMO CRM для **Задачи 2**. Создайте эти поля в AMO CRM и запишите их ID:
- Сумма выдана
- Валюта
- Счет списания
- Дата списания
- Администратор
- Карта
- Оплаченный сервис
- Почта
- Срок оплаты
- Статус

Чтобы найти ID полей:
1. Перейдите в AMO CRM в «Настройки» > «Пользовательские поля» > «Сделки».
2. Создайте или найдите нужные поля.
3. Используйте API AMO CRM или проверьте настройки полей, чтобы найти числовой `field_id` (например, `100001`).
4. Обновите объект `customFields` в `gtables2amo.js` с правильными значениями `field_id`:
   ```javascript
   const customFields = {
     amount_issued: ВАШ_FIELD_ID,
     currency: ВАШ_FIELD_ID,
     // ... остальные поля
   };
   ```

### 5. Настройка переменных окружения
Создайте файл `.env` в корне проекта со следующими переменными:

```env
# Настройки Google Таблиц
SPREADSHEET_ID=ваш_spreadsheet_id
SHEET_NAME=ваш_sheet_name
GOOGLE_CREDENTIALS='{"type":"service_account","project_id":"...","private_key":"...","client_email":"...","..."}'

# Настройки AMO CRM
AMO_DOMAIN=ваш_amo_domain
AMO_TOKEN=ваш_amo_token
```

- Замените `ваш_spreadsheet_id` на ID Google Таблицы.
- Замените `ваш_sheet_name` на название листа (например, «Sheet1»).
- Вставьте весь JSON объект учетных данных для `GOOGLE_CREDENTIALS` (в одинарных кавычках).
- Замените `ваш_amo_domain` на поддомен AMO CRM.
- Замените `ваш_amo_token` на API-токен AMO CRM.

### 6. Запуск скрипта
1. Убедитесь, что все зависимости установлены и файл `.env` настроен.
2. Установите PM2, если еще не установлен:

   ```bash
   npm install -g pm2
   ```

3. Запустите скрипт с помощью PM2:

   ```bash
   pm2 start gtables2amo.js
   ```

4. Скрипт будет:
   - Ожидать обновления из AMO CRM (для Задачи 1 требуется настройка вебхука; см. ниже).
   - Периодически (каждые 5 минут) проверять Google Таблицу на наличие новых строк и обновлять AMO CRM (Задача 2).

### 7. Настройка вебхука для Задачи 1
Скрипт содержит заглушку для обработки вебхуков AMO CRM (`handleAmoWebhook`). Для полной реализации Задачи 1:
1. Настройте HTTP-сервер (например, с использованием Express) для приема вебхуков от AMO CRM.
2. В AMO CRM настройте вебхук, чтобы отправлять обновления сделок на конечную точку вашего сервера (например, `https://ваш-сервер.com/webhook`).
3. Измените `handleAmoWebhook` для обработки полезной нагрузки вебхука и извлечения `deal_number` и `payment_link`.
4. Пример настройки с Express (добавьте в проект):

   ```javascript
   const express = require('express');
   const app = express();
   app.use(express.json());
   app.post('/webhook', async (req, res) => {
     const dealData = req.body; // Настройте в зависимости от формата вебхука AMO CRM
     await handleAmoWebhook(dealData);
     res.status(200).send('OK');
   });
   app.listen(3000, () => console.log('Сервер вебхуков запущен на порту 3000'));
   ```

   Установите Express:

   ```bash
   npm install express
   ```

### Устранение неполадок
- **Ошибки Google Sheets API**: Проверьте `GOOGLE_CREDENTIALS`, `SPREADSHEET_ID` и `SHEET_NAME`. Убедитесь, что сервисный аккаунт имеет права редактора для таблицы.
- **Ошибки AMO CRM API**: Проверьте `AMO_DOMAIN` и `AMO_TOKEN`. Убедитесь, что токен имеет права на чтение/запись сделок.
- **Ошибки пользовательских полей**: Убедитесь, что все ID полей в `customFields` совпадают с ID в AMO CRM.
- **Проблемы с вебхуком**: Убедитесь, что сервер общедоступен, и URL вебхука правильно настроен в AMO CRM.

### Примечания
- Скрипт выполняет Задачу 2 каждые 5 минут. При необходимости измените интервал в `setInterval`.
- Защитите файл `.env` и JSON учетных данных, так как они содержат конфиденциальную информацию.
- Для продакшена разверните скрипт на сервере (например, AWS, Heroku) и используйте PM2 для управления процессами.

Для дополнительной информации:
- [Документация Google Sheets API](https://developers.google.com/sheets/api)
- [Документация AMO CRM API](https://www.amocrm.com/developers/content/api/)