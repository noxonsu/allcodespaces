# API Обработки Лидов через Партнеров

Этот документ описывает API, предназначенное для интеграции с внешними партнерами, позволяя им использовать внутренние разработки для проведения оплат ChatGPT и отправки лидов на обработку, а также для операторов для отправки отчетов по лидам.

## Обзор

API предоставляет следующие основные возможности:
1.  **Аутентификация и идентификация партнеров** по уникальному API токену.
2.  **Управление балансом партнеров**: просмотр текущего баланса.
3.  **Расчет стоимости платежа**: определение стоимости платежа в валюте баланса партнера на основе актуальных курсов.
4.  **Проведение платежей**: списание средств с баланса партнера для оплаты услуг.
5.  **Отслеживание статуса транзакций**.
6.  **Прием лидов от партнеров**: получение данных от партнеров для дальнейшей обработки (интегрировано в основной API платежей).
7.  **Прием отчетов по лидам (Zeno Report)**: эндпоинт для операторов для отправки результатов обработки лидов.

Административная панель позволяет управлять партнерами, их балансами и курсами валют.

## Структура Папок (Основные)

*   `/amogt/`
    *   `amo2json.php`: Вебхук для приема лидов из AmoCRM.
    *   `zeno_report.php`: Эндпоинт для приема отчетов по лидам от операторов.
    *   `lib/`: Общие библиотеки (`json_storage_utils.php`, `request_utils.php`).
    *   `data/`:
        *   `allLeads.json`: Основной файл для хранения данных лидов (из AmoCRM и от партнеров).
        *   `recieved_api_ids.txt`: Хранит ID лидов, полученных от партнеров (для предотвращения дублей).
        *   `recieved_amo_ids.txt`: Хранит ID сделок AmoCRM, по которым уже был отправлен отчет/обновление (для предотвращения дублей).
        *   `zeno_report.json`: Хранит отчеты, отправленные через `zeno_report.php`.
        *   `amo_fields.json`: Текстовый файл, содержащий JSON-структуру с описанием пользовательских полей из AmoCRM.
        *   `amo_tokens.json`: JSON-файл для хранения токенов доступа OAuth2 от AmoCRM.
        *   `blocked_deals.txt`: Текстовый файл, хранящий ID сделок AmoCRM, которые уже были обработаны.
        *   `my-project-1337-458418-4b4c595d74d5.json`: Файл ключа сервисного аккаунта Google Cloud.
        *   `mycity2_key.json`: Файл ключа сервисного аккаунта Google Cloud.
        *   `pipelines.json`: JSON-файл, содержащий структуру воронок и этапов из AmoCRM.
    *   `logs/`: Директория для лог-файлов.
*   `/amogt/gpt_payment_api/`
    *   `api.php`: Главный файл API, обрабатывающий все входящие запросы, связанные с платежами и приемом лидов от партнеров.
    *   `admin/`: Директория с файлами административной панели для управления партнерами, курсами валют и просмотра транзакций.
        *   `index.php`: Главный файл админ-панели с маршрутизацией.
        *   `auth.php`: Скрипт аутентификации администратора.
        *   `templates/`: HTML-шаблоны админ-панели.
        *   `actions/`: Скрипты обработки действий админ-панели.
    *   `lib/`: Вспомогательные PHP классы и функции для платежного API.
        *   `PartnerManager.php`: Управление партнерами.
        *   `CurrencyConverter.php`: Работа с курсами валют и конвертацией.
        *   `TransactionManager.php`: Управление транзакциями.
        *   `Auth.php`: Проверка API-токенов партнеров.
    *   `data/`: Данные платежного API.
        *   `partners.json`: Информация о партнерах.
        *   `rates.json`: Курсы валют.
        *   `transactions.json`: Информация о транзакциях.

## Детальная структура файлов и их назначение

Ниже представлено более подробное описание ключевых файлов и директорий проекта:

*   **`/amogt/` (корневая директория проекта)**
    *   `.env`: Файл конфигурации переменных окружения (необходимо создать на основе `.env.example` или аналогичного). Хранит чувствительные данные, такие как ключи API, учетные данные базы данных и т.д. **Никогда не должен попадать в систему контроля версий.**
    *   `.gitignore`: Определяет намеренно неотслеживаемые файлы, которые Git должен игнорировать.
    *   `.htaccess`: Файл конфигурации для веб-сервера Apache, используется для ограничения доступа к чувствительным файлам.
    *   `amo2excel.php`: Скрипт, который, вероятно, обрабатывает вебхуки от AmoCRM и выгружает данные в Google Sheets (судя по названию и возможной предыдущей функциональности). Также включает логику для `amo2json.php`.
    *   `amo2json.php`: Скрипт, обрабатывающий вебхуки от AmoCRM. Сохраняет или обновляет данные о лидах в `allLeads.json`. Также содержит логику для предотвращения дублирования обработки.
    *   `composer.json`: Файл конфигурации для менеджера зависимостей Composer (PHP). Определяет зависимости проекта, такие как `google/apiclient` и `phpoffice/phpspreadsheet`.
    *   `config.php`: PHP-файл конфигурации. Загружает переменные из `.env`, определяет константы (например, для доступа к AmoCRM, Google Drive, пути к файлам) и основные настройки приложения.
    *   `debug_page.html`: HTML-файл, вероятно, используемый для отладки парсинга страниц Stripe или других внешних сервисов.
    *   `excel2amo.php`: Скрипт для синхронизации данных из Google Sheets в AmoCRM.
    *   `index.php`: Основной скрипт, который может запускать периодические задачи, такие как `excel2amo.php`, и проверять доступ к AmoCRM.
    *   `lib/`: Директория с общими вспомогательными PHP-библиотеками.
        *   `json_storage_utils.php`: Функции для работы с JSON-файлами (чтение, запись).
        *   `request_utils.php`: Функции для выполнения HTTP-запросов, управления lock-файлами для предотвращения одновременного выполнения скриптов.
        *   `driveutils.php`: (Предположительно, на основе `excel2amo.php` и `amo2excel.php`) Функции для работы с Google Drive API, включая Google Sheets.
    *   `logger.php`: Скрипт с функциями для логирования сообщений (info, error, debug) в файлы и, опционально, вывода в браузер.
    *   `logs/`: Директория для хранения лог-файлов различных скриптов (`app.log`, `amo2us.log`, `zeno_report.log` и т.д.).
    *   `parseStripe.js`: Node.js скрипт, использующий Puppeteer для парсинга информации о платежах со страниц Stripe.
    *   `readme.md`: Данный файл с описанием проекта.
    *   `test_partner_api.php`: PHP-скрипт для тестирования партнерского API.
    *   `zeno_report.php`: Эндпоинт для приема отчетов по обработанным лидам от операторов или систем автоматизации (например, Zeno). Сохраняет отчеты в `zeno_report.json` и, если лид не от партнера, обновляет соответствующую сделку в AmoCRM.
    *   `data/`: Директория для хранения файлов данных.
        *   `allLeads.json`: Основной JSON-файл, агрегирующий лиды из AmoCRM и от партнеров.
        *   `amo_fields.json`: Текстовый файл, содержащий JSON-структуру с описанием пользовательских полей из AmoCRM.
        *   `amo_tokens.json`: JSON-файл для хранения токенов доступа OAuth2 от AmoCRM.
        *   `blocked_deals.txt`: Текстовый файл, хранящий ID сделок AmoCRM, которые уже были обработаны.
        *   `my-project-1337-458418-4b4c595d74d5.json`: Файл ключа сервисного аккаунта Google Cloud.
        *   `mycity2_key.json`: Файл ключа сервисного аккаунта Google Cloud.
        *   `pipelines.json`: JSON-файл, содержащий структуру воронок и этапов из AmoCRM.
        *   `recieved_api_ids.txt`: Текстовый файл, хранящий ID лидов, полученных от партнеров через API.
        *   `recieved_amo_ids.txt`: Текстовый файл, хранящий ID сделок AmoCRM, по которым уже был отправлен отчет/обновление.
        *   `zeno_report.json`: JSON-файл для хранения отчетов, отправленных через `zeno_report.php`.

*   **`/amogt/gpt_payment_api/` (API для партнеров)**
    *   `api.php`: Основной файл-контроллер партнерского API. Обрабатывает запросы на получение баланса, расчет стоимости платежа, проведение платежа, получение статуса транзакции и прием лидов от партнеров (`submit_partner_lead`).
    *   `admin/`: Директория с файлами административной панели для управления партнерами, курсами валют и просмотра транзакций.
        *   `index.php`: Главный файл админ-панели, маршрутизирующий запросы к соответствующим разделам (партнеры, курсы, транзакции).
        *   `auth.php`: Скрипт для аутентификации администратора.
        *   `templates/`: Директория с HTML-шаблонами для админ-панели.
            *   `header.php`, `footer.php`: Общие части HTML-страниц.
            *   `login.php`: Шаблон страницы входа.
            *   `partners.php`: Шаблон страницы управления партнерами.
            *   `rates.php`: Шаблон страницы управления курсами валют.
            *   `transactions.php`: Шаблон страницы просмотра транзакций.
            *   `instructions.php`: HTML-страница с инструкциями по использованию партнерского API (доступна из админ-панели). Содержит описание эндпоинтов, параметров, примеров запросов и ответов.
        *   `actions/`: Директория со скриптами, обрабатывающими действия из админ-панели (например, `add_partner.php`, `edit_balance.php`, `set_rate.php`).
    *   `lib/`: Вспомогательные PHP-классы и функции, специфичные для партнерского API.
        *   `PartnerManager.php`: Класс для управления партнерами (добавление, получение, обновление баланса, удаление).
        *   `CurrencyConverter.php`: Класс для работы с курсами валют и конвертации сумм.
        *   `TransactionManager.php`: Класс для управления транзакциями (создание, получение статуса).
        *   `Auth.php`: Класс для проверки API-токенов партнеров.
    *   `data/`: Директория для хранения данных, специфичных для партнерского API.
        *   `partners.json`: JSON-файл для хранения информации о партнерах (ID, имя, API-токен, баланс).
        *   `rates.json`: JSON-файл для хранения курсов валют.
        *   `transactions.json`: JSON-файл для хранения информации о транзакциях.

## Конфигурация

Основные настройки API и админки должны быть заданы в файле `.env` в корневой директории `amogt/`.
*   `GPT_ADMIN_USERNAME`, `GPT_ADMIN_PASSWORD_HASH`
*   Настройки AmoCRM (`AMO_DOMAIN`, `AMO_INTEGRATION_ID` и т.д.)
*   Прочие настройки, как указано в `config.php`.

## Общая схема работы с лидами

Лиды в системе могут поступать из двух источников и обрабатываются следующим образом:

1.  **Лиды из AmoCRM**:
    *   Поступают через вебхук на скрипт `amogt/amo2json.php`.
    *   Данные о лиде (включая `dealId` и `paymentUrl`) сохраняются в основной файл данных лидов: `amogt/allLeads.json`.
    *   Этот файл используется для дальнейшей обработки и отображения.

2.  **Лиды от Партнеров**:
    *   Поступают через основной API `amogt/gpt_payment_api/api.php` с `action=submit_partner_lead`.
    *   Партнер передает массив лидов, каждый из которых должен содержать `dealId` (уникальный ID лида со стороны партнера).
    *   Перед сохранением, `dealId` каждого лида проверяется на дубликат в файле `amogt/recieved_api_ids.txt`. Если ID уже существует, лид пропускается. Новые ID добавляются в этот файл.
    *   Данные успешно принятых лидов (с добавлением `partnerId` и `partner_name` на основе API токена) также сохраняются в основной файл `amogt/allLeads.json`.

3.  **Обработка лидов и Отчетность (Операторы/Zeno)**:
    *   Система автоматизации (например, Zeno) получает список лидов для обработки из `amogt/alldeals_json.php`.
    *   После выполнения работы по лиду, система автоматизации (или оператор вручную) отправляет отчет через эндпоинт `amogt/zeno_report.php`.
    *   **Параметры `zeno_report.php`**:
        *   `GET id={lead_id}`: Где `{lead_id}` - это `dealId` из `allLeads.json`.
        *   `POST data`: Включает `status` ("Успешно" или "ОШИБКА!"), опциональные поля (`amount`, `currency`, `email`, `card`) и опциональный `partner_id`.
    *   **Логика `zeno_report.php`**:
        *   Все отчеты сохраняются в `amogt/zeno_report.json`.
        *   Если в POST-запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
        *   Если `partner_id` **отсутствует**:
            *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
            *   Если `lead_id` новый, он добавляется в `recieved_amo_ids.txt`.
            *   Производится поиск сделки в AmoCRM по `lead_id`.
            *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `recieved_amo_ids.txt` служат для предотвращения дублирующей обработки и обновлений.

## Эндпоинты API

### Основной API Партнеров (Платежи и Прием Лидов)

Все запросы к этому API должны отправляться на `ваш_домен/amogt/gpt_payment_api/api.php`.
Метод передачи параметров: `GET` или `POST` (для `submit_partner_lead` - `POST` с JSON телом).
Формат ответа: JSON.

#### Общие параметры для большинства запросов (если не указано иное):
*   `api_token` (string, required): Уникальный API токен партнера. Передается как GET/POST параметр, либо в JSON теле для `submit_partner_lead`.

#### 1. Получение баланса партнера
*   **Action**: `get_balance`
    *   ... (описание без изменений) ...

#### 2. Отправка лидов от партнера (пакетная)
*   **Action**: `submit_partner_lead`
*   **Метод**: `POST`
*   **Формат запроса**: JSON (тело запроса)
*   **Параметры (в теле JSON-запроса)**:
    *   `action` (string, required): Должен быть `"submit_partner_lead"`.
    *   `api_token` (string, required): Уникальный API токен партнера для аутентификации.
    *   `lead_data` (array, required): Массив JSON-объектов, где каждый объект представляет лид. Каждый лид должен содержать как минимум `paymentUrl`. Поля `dealId`, `created_at` и `last_updated` всегда генерируются сервером и не принимаются от партнера. Любые другие пользовательские поля также могут быть включены. Поле `partnerId` будет добавлено/перезаписано сервером на основе `api_token`.
*   **Пример тела запроса**:
    ```json
    {
        "action": "submit_partner_lead",
        "api_token": "ВАШ_API_ТОКЕН",
        "lead_data": [
            {
                "paymentUrl": "https://pay.openai.com/...",
                "custom_field_example": "some_value"
            },
            {
                "paymentUrl": "https://another-service.com/pay/...",
                "custom_notes": "Another lead with different data"
            }
        ]
    }
    ```
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Processed X leads. Added to main list: Y, Updated in main list: Z.",
        "processed_count": X,
        "added_to_main_list_count": Y,
        "updated_in_main_list_count": Z,
        "errors": [] // Массив ошибок, если какие-то лиды не удалось обработать или были дублями
    }
    ```
*   **Ошибки**: 400, 401, 405, 429, 500.

## Инструкция для Zeno автоматизации (и других систем обработки лидов)

Этот раздел описывает, как внешние системы автоматизации (например, Zeno) должны взаимодействовать с API для получения списка задач (лидов) и отправки отчетов об их выполнении.

### 1. Получение списка активных лидов (задач)

Для получения полного списка текущих лидов, которые требуют обработки, система автоматизации должна выполнить GET-запрос к следующему эндпоинту:

*   **URL**: `https://ваш_домен/amogt/amodeals_json.php` (без параметров)
*   **Метод**: `GET`
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "deals": [
            {
                "dealId": "14252569",
                "paymentUrl": "https://pay.openai.com/...",
                "created_at": "2025-06-09 08:47:02",
                "last_updated": "2025-06-09 08:47:02",
                "partnerId": "partner_id_если_есть", // Поле будет присутствовать, если лид от партнера
                "partner_name": "Имя партнера если есть" 
                // ... другие поля, которые были сохранены для лида ...
            },
            // ... другие лиды
        ],
        "total": X, // Общее количество лидов
        "message": "Current deals in JSON file.",
        "info": { ... } // Дополнительная информация об использовании скрипта
    }
    ```
*   **Примечание**: Система автоматизации должна сама определить, какие из полученных лидов являются "новыми" или "необработанными" (например, сравнивая с ранее полученными ID или проверяя наличие отчета в `zeno_report.json`).

### 2. Отправка отчета о выполнении задачи

После выполнения работы по лиду, система автоматизации отправляет отчет через следующий эндпоинт:

*   **URL**: `https://ваш_домен/amogt/zeno_report.php?id={lead_id}`
    *   `{lead_id}`: ID лида (соответствует `dealId` из файла `allLeads.json`).
*   **Метод**: `POST`
*   **Формат запроса**: `application/x-www-form-urlencoded` или `multipart/form-data`.
*   **Параметры (в теле POST-запроса)**:
    *   `status` (string, required): Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
    *   `amount` (string, optional): Сумма (если применимо).
    *   `currency` (string, optional): Валюта (если применимо).
    *   `email` (string, optional): Email (если применимо).
    *   `card` (string, optional): Карта (если применимо).
    *   `partner_id` (string, optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
    *   *Любые другие поля, которые система автоматизации хочет передать в отчете.*
*   **Логика на стороне сервера (`zeno_report.php`)**:
    1.  Отчет сохраняется в `amogt/zeno_report.json`.
    2.  Если в POST-запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
    3.  Если `partner_id` **отсутствует**:
        *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
        *   Если не обработан, `lead_id` добавляется в `recieved_amo_ids.txt`.
        *   Производится поиск сделки в AmoCRM по `lead_id`.
        *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `recieved_amo_ids.txt` служат для предотвращения дублирующей обработки и обновлений.

## Эндпоинты API

### Основной API Партнеров (Платежи и Прием Лидов)

Все запросы к этому API должны отправляться на `ваш_домен/amogt/gpt_payment_api/api.php`.
Метод передачи параметров: `GET` или `POST` (для `submit_partner_lead` - `POST` с JSON телом).
Формат ответа: JSON.

#### Общие параметры для большинства запросов (если не указано иное):
*   `api_token` (string, required): Уникальный API токен партнера. Передается как GET/POST параметр, либо в JSON теле для `submit_partner_lead`.

#### 1. Получение баланса партнера
*   **Action**: `get_balance`
    *   ... (описание без изменений) ...

#### 2. Отправка лидов от партнера (пакетная)
*   **Action**: `submit_partner_lead`
*   **Метод**: `POST`
*   **Формат запроса**: JSON (тело запроса)
*   **Параметры (в теле JSON-запроса)**:
    *   `action` (string, required): Должен быть `"submit_partner_lead"`.
    *   `api_token` (string, required): Уникальный API токен партнера для аутентификации.
    *   `lead_data` (array, required): Массив JSON-объектов, где каждый объект представляет лид. Каждый лид должен содержать как минимум `paymentUrl`. Поля `dealId`, `created_at` и `last_updated` всегда генерируются сервером и не принимаются от партнера. Любые другие пользовательские поля также могут быть включены. Поле `partnerId` будет добавлено/перезаписано сервером на основе `api_token`.
*   **Пример тела запроса**:
    ```json
    {
        "action": "submit_partner_lead",
        "api_token": "ВАШ_API_ТОКЕН",
        "lead_data": [
            {
                "paymentUrl": "https://pay.openai.com/...",
                "custom_field_example": "some_value"
            },
            {
                "paymentUrl": "https://another-service.com/pay/...",
                "custom_notes": "Another lead with different data"
            }
        ]
    }
    ```
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Processed X leads. Added to main list: Y, Updated in main list: Z.",
        "processed_count": X,
        "added_to_main_list_count": Y,
        "updated_in_main_list_count": Z,
        "errors": [] // Массив ошибок, если какие-то лиды не удалось обработать или были дублями
    }
    ```
*   **Ошибки**: 400, 401, 405, 429, 500.

## Инструкция для Zeno автоматизации (и других систем обработки лидов)

Этот раздел описывает, как внешние системы автоматизации (например, Zeno) должны взаимодействовать с API для получения списка задач (лидов) и отправки отчетов об их выполнении.

### 1. Получение списка активных лидов (задач)

Для получения полного списка текущих лидов, которые требуют обработки, система автоматизации должна выполнить GET-запрос к следующему эндпоинту:

*   **URL**: `https://ваш_домен/amogt/amodeals_json.php` (без параметров)
*   **Метод**: `GET`
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "deals": [
            {
                "dealId": "14252569",
                "paymentUrl": "https://pay.openai.com/...",
                "created_at": "2025-06-09 08:47:02",
                "last_updated": "2025-06-09 08:47:02",
                "partnerId": "partner_id_если_есть", // Поле будет присутствовать, если лид от партнера
                "partner_name": "Имя партнера если есть" 
                // ... другие поля, которые были сохранены для лида ...
            },
            // ... другие лиды
        ],
        "total": X, // Общее количество лидов
        "message": "Current deals in JSON file.",
        "info": { ... } // Дополнительная информация об использовании скрипта
    }
    ```
*   **Примечание**: Система автоматизации должна сама определить, какие из полученных лидов являются "новыми" или "необработанными" (например, сравнивая с ранее полученными ID или проверяя наличие отчета в `zeno_report.json`).

### 2. Отправка отчета о выполнении задачи

После выполнения работы по лиду, система автоматизации отправляет отчет через следующий эндпоинт:

*   **URL**: `https://ваш_домен/amogt/zeno_report.php?id={lead_id}`
    *   `{lead_id}`: ID лида (соответствует `dealId` из файла `allLeads.json`).
*   **Метод**: `POST`
*   **Формат запроса**: `application/x-www-form-urlencoded` или `multipart/form-data`.
*   **Параметры (в теле POST-запроса)**:
    *   `status` (string, required): Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
    *   `amount` (string, optional): Сумма (если применимо).
    *   `currency` (string, optional): Валюта (если применимо).
    *   `email` (string, optional): Email (если применимо).
    *   `card` (string, optional): Карта (если применимо).
    *   `partner_id` (string, optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
    *   *Любые другие поля, которые система автоматизации хочет передать в отчете.*
*   **Логика на стороне сервера (`zeno_report.php`)**:
    1.  Отчет сохраняется в `amogt/zeno_report.json`.
    2.  Если в POST-запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
    3.  Если `partner_id` **отсутствует**:
        *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
        *   Если не обработан, `lead_id` добавляется в `recieved_amo_ids.txt`.
        *   Производится поиск сделки в AmoCRM по `lead_id`.
        *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `recieved_amo_ids.txt` служат для предотвращения дублирующей обработки и обновлений.

## Эндпоинты API

### Основной API Партнеров (Платежи и Прием Лидов)

Все запросы к этому API должны отправляться на `ваш_домен/amogt/gpt_payment_api/api.php`.
Метод передачи параметров: `GET` или `POST` (для `submit_partner_lead` - `POST` с JSON телом).
Формат ответа: JSON.

#### Общие параметры для большинства запросов (если не указано иное):
*   `api_token` (string, required): Уникальный API токен партнера. Передается как GET/POST параметр, либо в JSON теле для `submit_partner_lead`.

#### 1. Получение баланса партнера
*   **Action**: `get_balance`
    *   ... (описание без изменений) ...

#### 2. Отправка лидов от партнера (пакетная)
*   **Action**: `submit_partner_lead`
*   **Метод**: `POST`
*   **Формат запроса**: JSON (тело запроса)
*   **Параметры (в теле JSON-запроса)**:
    *   `action` (string, required): Должен быть `"submit_partner_lead"`.
    *   `api_token` (string, required): Уникальный API токен партнера для аутентификации.
    *   `lead_data` (array, required): Массив JSON-объектов, где каждый объект представляет лид. Каждый лид должен содержать как минимум `paymentUrl`. Поля `dealId`, `created_at` и `last_updated` всегда генерируются сервером и не принимаются от партнера. Любые другие пользовательские поля также могут быть включены. Поле `partnerId` будет добавлено/перезаписано сервером на основе `api_token`.
*   **Пример тела запроса**:
    ```json
    {
        "action": "submit_partner_lead",
        "api_token": "ВАШ_API_ТОКЕН",
        "lead_data": [
            {
                "paymentUrl": "https://pay.openai.com/...",
                "custom_field_example": "some_value"
            },
            {
                "paymentUrl": "https://another-service.com/pay/...",
                "custom_notes": "Another lead with different data"
            }
        ]
    }
    ```
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Processed X leads. Added to main list: Y, Updated in main list: Z.",
        "processed_count": X,
        "added_to_main_list_count": Y,
        "updated_in_main_list_count": Z,
        "errors": [] // Массив ошибок, если какие-то лиды не удалось обработать или были дублями
    }
    ```
*   **Ошибки**: 400, 401, 405, 429, 500.

## Инструкция для Zeno автоматизации (и других систем обработки лидов)

Этот раздел описывает, как внешние системы автоматизации (например, Zeno) должны взаимодействовать с API для получения списка задач (лидов) и отправки отчетов об их выполнении.

### 1. Получение списка активных лидов (задач)

Для получения полного списка текущих лидов, которые требуют обработки, система автоматизации должна выполнить GET-запрос к следующему эндпоинту:

*   **URL**: `https://ваш_домен/amogt/amodeals_json.php` (без параметров)
*   **Метод**: `GET`
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "deals": [
            {
                "dealId": "14252569",
                "paymentUrl": "https://pay.openai.com/...",
                "created_at": "2025-06-09 08:47:02",
                "last_updated": "2025-06-09 08:47:02",
                "partnerId": "partner_id_если_есть", // Поле будет присутствовать, если лид от партнера
                "partner_name": "Имя партнера если есть" 
                // ... другие поля, которые были сохранены для лида ...
            },
            // ... другие лиды
        ],
        "total": X, // Общее количество лидов
        "message": "Current deals in JSON file.",
        "info": { ... } // Дополнительная информация об использовании скрипта
    }
    ```
*   **Примечание**: Система автоматизации должна сама определить, какие из полученных лидов являются "новыми" или "необработанными" (например, сравнивая с ранее полученными ID или проверяя наличие отчета в `zeno_report.json`).

### 2. Отправка отчета о выполнении задачи

После выполнения работы по лиду, система автоматизации отправляет отчет через следующий эндпоинт:

*   **URL**: `https://ваш_домен/amogt/zeno_report.php?id={lead_id}`
    *   `{lead_id}`: ID лида (соответствует `dealId` из файла `allLeads.json`).
*   **Метод**: `POST`
*   **Формат запроса**: `application/x-www-form-urlencoded` или `multipart/form-data`.
*   **Параметры (в теле POST-запроса)**:
    *   `status` (string, required): Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
    *   `amount` (string, optional): Сумма (если применимо).
    *   `currency` (string, optional): Валюта (если применимо).
    *   `email` (string, optional): Email (если применимо).
    *   `card` (string, optional): Карта (если применимо).
    *   `partner_id` (string, optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
    *   *Любые другие поля, которые система автоматизации хочет передать в отчете.*
*   **Логика на стороне сервера (`zeno_report.php`)**:
    1.  Отчет сохраняется в `amogt/zeno_report.json`.
    2.  Если в POST-запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
    3.  Если `partner_id` **отсутствует**:
        *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
        *   Если не обработан, `lead_id` добавляется в `recieved_amo_ids.txt`.
        *   Производится поиск сделки в AmoCRM по `lead_id`.
        *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `recieved_amo_ids.txt` служат для предотвращения дублирующей обработки и обновлений.

## Эндпоинты API

### Основной API Партнеров (Платежи и Прием Лидов)

Все запросы к этому API должны отправляться на `ваш_домен/amogt/gpt_payment_api/api.php`.
Метод передачи параметров: `GET` или `POST` (для `submit_partner_lead` - `POST` с JSON телом).
Формат ответа: JSON.

#### Общие параметры для большинства запросов (если не указано иное):
*   `api_token` (string, required): Уникальный API токен партнера. Передается как GET/POST параметр, либо в JSON теле для `submit_partner_lead`.

#### 1. Получение баланса партнера
*   **Action**: `get_balance`
    *   ... (описание без изменений) ...

#### 2. Отправка лидов от партнера (пакетная)
*   **Action**: `submit_partner_lead`
*   **Метод**: `POST`
*   **Формат запроса**: JSON (тело запроса)
*   **Параметры (в теле JSON-запроса)**:
    *   `action` (string, required): Должен быть `"submit_partner_lead"`.
    *   `api_token` (string, required): Уникальный API токен партнера для аутентификации.
    *   `lead_data` (array, required): Массив JSON-объектов, где каждый объект представляет лид. Каждый лид должен содержать как минимум `paymentUrl`. Поля `dealId`, `created_at` и `last_updated` всегда генерируются сервером и не принимаются от партнера. Любые другие пользовательские поля также могут быть включены. Поле `partnerId` будет добавлено/перезаписано сервером на основе `api_token`.
*   **Пример тела запроса**:
    ```json
    {
        "action": "submit_partner_lead",
        "api_token": "ВАШ_API_ТОКЕН",
        "lead_data": [
            {
                "paymentUrl": "https://pay.openai.com/...",
                "custom_field_example": "some_value"
            },
            {
                "paymentUrl": "https://another-service.com/pay/...",
                "custom_notes": "Another lead with different data"
            }
        ]
    }
    ```
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Processed X leads. Added to main list: Y, Updated in main list: Z.",
        "processed_count": X,
        "added_to_main_list_count": Y,
        "updated_in_main_list_count": Z,
        "errors": [] // Массив ошибок, если какие-то лиды не удалось обработать или были дублями
    }
    ```
*   **Ошибки**: 400, 401, 405, 429, 500.

## Инструкция для Zeno автоматизации (и других систем обработки лидов)

Этот раздел описывает, как внешние системы автоматизации (например, Zeno) должны взаимодействовать с API для получения списка задач (лидов) и отправки отчетов об их выполнении.

### 1. Получение списка активных лидов (задач)

Для получения полного списка текущих лидов, которые требуют обработки, система автоматизации должна выполнить GET-запрос к следующему эндпоинту:

*   **URL**: `https://ваш_домен/amogt/amodeals_json.php` (без параметров)
*   **Метод**: `GET`
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "deals": [
            {
                "dealId": "14252569",
                "paymentUrl": "https://pay.openai.com/...",
                "created_at": "2025-06-09 08:47:02",
                "last_updated": "2025-06-09 08:47:02",
                "partnerId": "partner_id_если_есть", // Поле будет присутствовать, если лид от партнера
                "partner_name": "Имя партнера если есть" 
                // ... другие поля, которые были сохранены для лида ...
            },
            // ... другие лиды
        ],
        "total": X, // Общее количество лидов
        "message": "Current deals in JSON file.",
        "info": { ... } // Дополнительная информация об использовании скрипта
    }
    ```
*   **Примечание**: Система автоматизации должна сама определить, какие из полученных лидов являются "новыми" или "необработанными" (например, сравнивая с ранее полученными ID или проверяя наличие отчета в `zeno_report.json`).

### 2. Отправка отчета о выполнении задачи

После выполнения работы по лиду, система автоматизации отправляет отчет через следующий эндпоинт:

*   **URL**: `https://ваш_домен/amogt/zeno_report.php?id={lead_id}`
    *   `{lead_id}`: ID лида (соответствует `dealId` из файла `allLeads.json`).
*   **Метод**: `POST`
*   **Формат запроса**: `application/x-www-form-urlencoded` или `multipart/form-data`.
*   **Параметры (в теле POST-запроса)**:
    *   `status` (string, required): Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
    *   `amount` (string, optional): Сумма (если применимо).
    *   `currency` (string, optional): Валюта (если применимо).
    *   `email` (string, optional): Email (если применимо).
    *   `card` (string, optional): Карта (если применимо).
    *   `partner_id` (string, optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
    *   *Любые другие поля, которые система автоматизации хочет передать в отчете.*
*   **Логика на стороне сервера (`zeno_report.php`)**:
    1.  Отчет сохраняется в `amogt/zeno_report.json`.
    2.  Если в POST-запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
    3.  Если `partner_id` **отсутствует**:
        *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
        *   Если не обработан, `lead_id` добавляется в `recieved_amo_ids.txt`.
        *   Производится поиск сделки в AmoCRM по `lead_id`.
        *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `recieved_amo_ids.txt` служат для предотвращения дублирующей обработки и обновлений.

## Эндпоинты API

### Основной API Партнеров (Платежи и Прием Лидов)

Все запросы к этому API должны отправляться на `ваш_домен/amogt/gpt_payment_api/api.php`.
Метод передачи параметров: `GET` или `POST` (для `submit_partner_lead` - `POST` с JSON телом).
Формат ответа: JSON.

#### Общие параметры для большинства запросов (если не указано иное):
*   `api_token` (string, required): Уникальный API токен партнера. Передается как GET/POST параметр, либо в JSON теле для `submit_partner_lead`.

#### 1. Получение баланса партнера
*   **Action**: `get_balance`
    *   ... (описание без изменений) ...

#### 2. Отправка лидов от партнера (пакетная)
*   **Action**: `submit_partner_lead`
*   **Метод**: `POST`
*   **Формат запроса**: JSON (тело запроса)
*   **Параметры (в теле JSON-запроса)**:
    *   `action` (string, required): Должен быть `"submit_partner_lead"`.
    *   `api_token` (string, required): Уникальный API токен партнера для аутентификации.
    *   `lead_data` (array, required): Массив JSON-объектов, где каждый объект представляет лид. Каждый лид должен содержать как минимум `paymentUrl`. Поля `dealId`, `created_at` и `last_updated` всегда генерируются сервером и не принимаются от партнера. Любые другие пользовательские поля также могут быть включены. Поле `partnerId` будет добавлено/перезаписано сервером на основе `api_token`.
*   **Пример тела запроса**:
    ```json
    {
        "action": "submit_partner_lead",
        "api_token": "ВАШ_API_ТОКЕН",
        "lead_data": [
            {
                "paymentUrl": "https://pay.openai.com/...",
                "custom_field_example": "some_value"
            },
            {
                "paymentUrl": "https://another-service.com/pay/...",
                "custom_notes": "Another lead with different data"
            }
        ]
    }
    ```
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Processed X leads. Added to main list: Y, Updated in main list: Z.",
        "processed_count": X,
        "added_to_main_list_count": Y,
        "updated_in_main_list_count": Z,
        "errors": [] // Массив ошибок, если какие-то лиды не удалось обработать или были дублями
    }
    ```
*   **Ошибки**: 400, 401, 405, 429, 500.

## Инструкция для Zeno автоматизации (и других систем обработки лидов)

Этот раздел описывает, как внешние системы автоматизации (например, Zeno) должны взаимодействовать с API для получения списка задач (лидов) и отправки отчетов об их выполнении.

### 1. Получение списка активных лидов (задач)

Для получения полного списка текущих лидов, которые требуют обработки, система автоматизации должна выполнить GET-запрос к следующему эндпоинту:

*   **URL**: `https://ваш_домен/amogt/amodeals_json.php` (без параметров)
*   **Метод**: `GET`
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "deals": [
            {
                "dealId": "14252569",
                "paymentUrl": "https://pay.openai.com/...",
                "created_at": "2025-06-09 08:47:02",
                "last_updated": "2025-06-09 08:47:02",
                "partnerId": "partner_id_если_есть", // Поле будет присутствовать, если лид от партнера
                "partner_name": "Имя партнера если есть" 
                // ... другие поля, которые были сохранены для лида ...
            },
            // ... другие лиды
        ],
        "total": X, // Общее количество лидов
        "message": "Current deals in JSON file.",
        "info": { ... } // Дополнительная информация об использовании скрипта
    }
    ```
*   **Примечание**: Система автоматизации должна сама определить, какие из полученных лидов являются "новыми" или "необработанными" (например, сравнивая с ранее полученными ID или проверяя наличие отчета в `zeno_report.json`).

### 2. Отправка отчета о выполнении задачи

После выполнения работы по лиду, система автоматизации отправляет отчет через следующий эндпоинт:

*   **URL**: `https://ваш_домен/amogt/zeno_report.php?id={lead_id}`
    *   `{lead_id}`: ID лида (соответствует `dealId` из файла `allLeads.json`).
*   **Метод**: `POST`
*   **Формат запроса**: `application/x-www-form-urlencoded` или `multipart/form-data`.
*   **Параметры (в теле POST-запроса)**:
    *   `status` (string, required): Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
    *   `amount` (string, optional): Сумма (если применимо).
    *   `currency` (string, optional): Валюта (если применимо).
    *   `email` (string, optional): Email (если применимо).
    *   `card` (string, optional): Карта (если применимо).
    *   `partner_id` (string, optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
    *   *Любые другие поля, которые система автоматизации хочет передать в отчете.*
*   **Логика на стороне сервера (`zeno_report.php`)**:
    1.  Отчет сохраняется в `amogt/zeno_report.json`.
    2.  Если в POST-запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
    3.  Если `partner_id` **отсутствует**:
        *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
        *   Если не обработан, `lead_id` добавляется в `recieved_amo_ids.txt`.
        *   Производится поиск сделки в AmoCRM по `lead_id`.
        *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `recieved_amo_ids.txt` служат для предотвращения дублирующей обработки и обновлений.

## Эндпоинты API

### Основной API Партнеров (Платежи и Прием Лидов)

Все запросы к этому API должны отправляться на `ваш_домен/amogt/gpt_payment_api/api.php`.
Метод передачи параметров: `GET` или `POST` (для `submit_partner_lead` - `POST` с JSON телом).
Формат ответа: JSON.

#### Общие параметры для большинства запросов (если не указано иное):
*   `api_token` (string, required): Уникальный API токен партнера. Передается как GET/POST параметр, либо в JSON теле для `submit_partner_lead`.

#### 1. Получение баланса партнера
*   **Action**: `get_balance`
    *   ... (описание без изменений) ...

#### 2. Отправка лидов от партнера (пакетная)
*   **Action**: `submit_partner_lead`
*   **Метод**: `POST`
*   **Формат запроса**: `JSON` (тело запроса)
*   **Параметры (в теле JSON-запроса)**:
    *   `action` (string, required): Должен быть `"submit_partner_lead"`.
    *   `api_token` (string, required): Уникальный API токен партнера для аутентификации.
    *   `lead_data` (array, required): Массив JSON-объектов, где каждый объект представляет лид. Каждый лид должен содержать как минимум `paymentUrl`. Поля `dealId`, `created_at` и `last_updated` всегда генерируются сервером и не принимаются от партнера. Любые другие пользовательские поля также могут быть включены. Поле `partnerId` будет добавлено/перезаписано сервером на основе `api_token`.
*   **Пример тела запроса**:
    ```json
    {
        "action": "submit_partner_lead",
        "api_token": "ВАШ_API_ТОКЕН",
        "lead_data": [
            {
                "paymentUrl": "https://pay.openai.com/...",
                "custom_field_example": "some_value"
            },
            {
                "paymentUrl": "https://another-service.com/pay/...",
                "custom_notes": "Another lead with different data"
            }
        ]
    }
    ```
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Processed X leads. Added to main list: Y, Updated in main list: Z.",
        "processed_count": X,
        "added_to_main_list_count": Y,
        "updated_in_main_list_count": Z,
        "errors": [] // Массив ошибок, если какие-то лиды не удалось обработать или были дублями
    }
    ```
*   **Ошибки**: 400, 401, 405, 429, 500.

## Инструкция для Zeno автоматизации (и других систем обработки лидов)

Этот раздел описывает, как внешние системы автоматизации (например, Zeno) должны взаимодействовать с API для получения списка задач (лидов) и отправки отчетов об их выполнении.

### 1. Получение списка активных лидов (задач)

Для получения полного списка текущих лидов, которые требуют обработки, система автоматизации должна выполнить GET-запрос к следующему эндпоинту:

*   **URL**: `https://ваш_домен/amogt/amodeals_json.php` (без параметров)
*   **Метод**: `GET`
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "deals": [
            {
                "dealId": "14252569",
                "paymentUrl": "https://pay.openai.com/...",
                "created_at": "2025-06-09 08:47:02",
                "last_updated": "2025-06-09 08:47:02",
                "partnerId": "partner_id_если_есть", // Поле будет присутствовать, если лид от партнера
                "partner_name": "Имя партнера если есть" 
                // ... другие поля, которые были сохранены для лида ...
            },
            // ... другие лиды
        ],
        "total": X, // Общее количество лидов
        "message": "Current deals in JSON file.",
        "info": { ... } // Дополнительная информация об использовании скрипта
    }
    ```
*   **Примечание**: Система автоматизации должна сама определить, какие из полученных лидов являются "новыми" или "необработанными" (например, сравнивая с ранее полученными ID или проверяя наличие отчета в `zeno_report.json`).

### 2. Отправка отчета о выполнении задачи

После выполнения работы по лиду, система автоматизации отправляет отчет через следующий эндпоинт:

*   **URL**: `https://ваш_домен/amogt/zeno_report.php?id={lead_id}`
    *   `{lead_id}`: ID лида (соответствует `dealId` из файла `allLeads.json`).
*   **Метод**: `POST`
*   **Формат запроса**: `application/x-www-form-urlencoded` или `multipart/form-data`.
*   **Параметры (в теле POST-запроса)**:
    *   `status` (string, required): Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
    *   `amount` (string, optional): Сумма (если применимо).
    *   `currency` (string, optional): Валюта (если применимо).
    *   `email` (string, optional): Email (если применимо).
    *   `card` (string, optional): Карта (если применимо).
    *   `partner_id` (string, optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
    *   *Любые другие поля, которые система автоматизации хочет передать в отчете.*
*   **Логика на стороне сервера (`zeno_report.php`)**:
    1.  Отчет сохраняется в `amogt/zeno_report.json`.
    2.  Если в POST-запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
    3.  Если `partner_id` **отсутствует**:
        *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/recieved_amo_ids.txt`).
        *   Если не обработан, `lead_id` добавляется в `recieved_amo_ids.txt`.
        *   Производится поиск сделки в AmoCRM по `lead_id`.
        *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `recieved_amo_ids.txt` служат для предотвращения дублирующей обработки и обновлений.
