# API Обработки Лидов через Партнеров

Этот документ описывает API, предназначенное для интеграции с внешними партнерами, позволяя им использовать внутренние разработки для проведения оплат ChatGPT и отправки лидов на обработку, а также для операторов для отправки отчетов по лидам.

## Обзор

API предоставляет следующие основные возможности:
1.  **Аутентификация и идентификация партнеров** по уникальному API токену.
2.  **Управление балансом партнеров**: просмотр текущего баланса.
3.  **Расчет стоимости платежа**: определение стоимости платежа в валюте баланса партнера на основе актуальных курсов.
4.  **Проведение платежей**: списание средств с баланса партнера для оплаты услуг.
5.  **Отслеживание статуса транзакций**.
6.  **Прием лидов от партнеров**: получение данных от партнеров для дальнейшей обработки (интегрировано в основной API платежей).
7.  **Прием отчетов по лидам (Zeno Report)**: эндпоинт для операторов для отправки результатов обработки лидов.

Административная панель позволяет управлять партнерами, их балансами и курсами валют.

## Структура Папок (Основные)

*   `/amogt/`
    *   `amo2excel.php`: Точка входа для вебхуков AmoCRM, передает управление `amo2json.php`.
    *   `amo2json.php`: Вебхук для приема лидов из AmoCRM. Парсит ссылки на оплату и обновляет сделки в AmoCRM.
    *   `alldeals_json.php`: Скрипт для просмотра и управления локальным JSON-файлом со сделками (`data/allLeads.json`).
    *   `excel2amo.php`: Скрипт для синхронизации данных из Google Sheets в AmoCRM.
    *   `index.php`: Основной скрипт, который может запускать периодические задачи и проверять доступ к AmoCRM.
    *   `logger.php`: Скрипт с функциями для логирования сообщений (info, error, debug) в файлы и, опционально, вывода в браузер.
  
    *   `zeno_report.php`: Эндпоинт для приема отчетов по лидам от операторов.
    *   `lib/`: Общие вспомогательные PHP-библиотеки.
        *   `amo_auth_utils.php`: Функции для аутентификации AmoCRM (получение и обновление OAuth2 токенов).
        *   `json_storage_utils.php`: Функции для работы с JSON-файлами (чтение, запись).
        *   `payment_link_parser.php`: Функции для парсинга ссылок на оплату (например, со страниц Stripe).
        *   `request_utils.php`: Функции для выполнения HTTP-запросов, управления lock-файлами для предотвращения одновременного выполнения скриптов.
        *   `driveutils.php`: Функции для работы с Google Drive API, включая Google Sheets.
    *   `data/`: Директория для хранения файлов данных.
        *   `allLeads.json`: Основной файл для хранения данных лидов (из AmoCRM и от партнеров).
        *   `recieved_api_ids.txt`: Хранит ID лидов, полученных от партнеров (для предотвращения дублей).
        *   `recieved_amo_ids.txt`: Хранит ID сделок AmoCRM, по которым уже был отправлен отчет/обновление (для предотвращения дублей).
        *   `id_of_deals_sent_to_amo.txt`: Хранит ID сделок AmoCRM, по которым уже был отправлен отчет/обновление через `zeno_report.php`.
        *   `zeno_report.json`: Хранит отчеты, отправленные через `zeno_report.php`.
        *   `amo_fields.json`: Текстовый файл, содержащий JSON-структуру с описанием пользовательских полей из AmoCRM.
        *   `amo_tokens.json`: JSON-файл для хранения токенов доступа OAuth2 от AmoCRM.
        *   `blocked_deals.txt`: Текстовый файл, хранящий ID сделок AmoCRM, которые уже были обработаны.
        *   `my-project-1337-458418-4b4c595d74d5.json`: Файл ключа сервисного аккаунта Google Cloud.
        *   `mycity2_key.json`: Файл ключа сервисного аккаунта Google Cloud.
        *   `pipelines.json`: JSON-файл, содержащий структуру воронок и этапов из AmoCRM.
    *   `logs/`: Директория для лог-файлов.
*   `/amogt/gpt_payment_api/`
    *   `api.php`: Главный файл API, обрабатывающий все входящие запросы, связанные с платежами и приемом лидов от партнеров.
    *   `admin/`: Директория с файлами административной панели для управления партнерами, курсами валют и просмотра транзакций.
        *   `index.php`: Главный файл админ-панели с маршрутизацией.
        *   `auth.php`: Скрипт аутентификации администратора.
        *   `templates/`: HTML-шаблоны админ-панели.
        *   `actions/`: Скрипты обработки действий админ-панели.
    *   `lib/`: Вспомогательные PHP классы и функции для платежного API.
        *   `PartnerManager.php`: Управление партнерами.
        *   `CurrencyConverter.php`: Работа с курсами валют и конвертацией.
        *   `TransactionManager.php`: Управление транзакциями.
        *   `Auth.php`: Проверка API-токенов партнеров.
    *   `data/`: Данные платежного API.
        *   `partners.json`: Информация о партнерах.
        *   `rates.json`: Курсы валют.
        *   `transactions.json`: Информация о транзакциях.

## Конфигурация

Основные настройки API и админки должны быть заданы в файле `.env` в корневой директории `amogt/`.
*   `GPT_ADMIN_USERNAME`, `GPT_ADMIN_PASSWORD_HASH`
*   Настройки AmoCRM (`AMO_DOMAIN`, `AMO_INTEGRATION_ID` и т.д.)
*   Прочие настройки, как указано в `config.php`.

## Настройка окружений и ID AmoCRM

Проект поддерживает два окружения: `test` (тестовое) и `production` (рабочее). Конфигурация для каждого окружения хранится в соответствующих `.env` файлах:
*   `amogt/.env.test` - для тестового окружения.
*   `amogt/.env.production` - для рабочего окружения.

Файл `amogt/config.php` автоматически загружает переменные из нужного `.env` файла в зависимости от значения переменной окружения `APP_ENV`.
*   Если `APP_ENV` установлена в `production`, будет загружен `amogt/.env.production`.
*   В противном случае (если `APP_ENV` не установлена или имеет другое значение), будет загружен `amogt/.env.test`.

В этих `.env` файлах необходимо указать актуальные ID воронок, статусов и пользовательских полей для вашего экземпляра AmoCRM.

### Как установить окружение (APP_ENV)

Для выбора окружения (test или production) необходимо установить системную переменную окружения `APP_ENV`.

*   **Для Apache (через `.htaccess`):**
    Вы можете добавить следующую строку в файл `amogt/.htaccess` (или в конфигурацию VirtualHost вашего Apache сервера), чтобы установить окружение `production`:
    ```apache
    SetEnv APP_ENV production
    ```
    Если эта строка отсутствует или закомментирована, по умолчанию будет использоваться `test` окружение.

*   **В терминале (для текущей сессии):**
    ```bash
    export APP_ENV=production
    ```
    Эта команда установит `APP_ENV` только для текущей сессии терминала.

*   **Для постоянной установки (Linux/macOS):**
    Добавьте `export APP_ENV=production` в ваш файл `.bashrc`, `.zshrc` или `.profile`.

*   **На веб-сервере (Nginx + PHP-FPM):**
    Вам нужно будет добавить `env[APP_ENV] = production` в конфигурацию вашего PHP-FPM пула (например, `www.conf`) и перезагрузить PHP-FPM.

**Важно:** Устанавливайте `APP_ENV=production` только в тех окружениях, которые действительно являются production, чтобы избежать случайного использования production-ключей в тестовых средах.

### Как получить ID из AmoCRM

ID полей, воронок и статусов можно получить несколькими способами:

1.  **Через интерфейс AmoCRM (для полей):**
    *   Перейдите в AmoCRM -> Настройки -> Поля.
    *   При наведении на название поля или при его редактировании в URL или в инструментах разработчика браузера можно увидеть ID поля.

2.  **Через API AmoCRM:**
    *   Вы можете использовать API AmoCRM для получения списков полей, воронок и статусов вместе с их ID.
    *   Например, для получения полей сделок: `GET /api/v4/leads/custom_fields`
    *   Для получения воронок и их статусов: `GET /api/v4/leads/pipelines`

3.  **Из файлов `data/amo_fields.json` и `data/pipelines.json`:**
    Эти файлы в директории `amogt/data/` содержат JSON-структуры с описанием пользовательских полей и воронок (включая статусы) соответственно. Они, вероятно, являются экспортом или кэшем данных из вашего AmoCRM.
    *   **`amogt/data/amo_fields.json`**:
        *   Найдите нужное поле по его имени (`"name": "Имя поля"`).
        *   Соответствующий `"id"` будет ID этого поля.
        *   Для полей типа `select` (выпадающий список), таких как "Валюта запроса", внутри объекта поля будет массив `enums`, где каждый элемент содержит `"id"` (это Enum ID) и `"value"` (значение).
        Пример для поля "Валюта запроса":
        ```json
        {
            "id": 636815,
            "name": "Валюта запроса",
            "type": "select",
            // ... другие свойства ...
            "enums": [
                {"id": 456991, "value": "USD", "sort": 500},
                {"id": 456993, "value": "EUR", "sort": 1},
                // ... другие валюты ...
            ]
        }
        ```
        Здесь `636815` - это ID поля "Валюта запроса", а `456991` - это Enum ID для значения "USD".

    *   **`amogt/data/pipelines.json`**:
        *   Этот файл содержит массив воронок в `_embedded.pipelines`.
        *   Каждая воронка имеет `"id"` и `"name"`.
        *   Внутри каждой воронки в `_embedded.statuses` находится массив статусов (этапов) этой воронки, каждый со своим `"id"` и `"name"`.
        Пример для "Основной воронки" (ID `8824470`):
        ```json
        {
            "id": 8824470,
            "name": "Воронка",
            // ... другие свойства ...
            "_embedded": {
                "statuses": [
                    {
                        "id": 71325730,
                        "name": "Неразобранное",
                        // ...
                    },
                    {
                        "id": 74304782,
                        "name": "CHATGPT",
                        // ...
                    }
                    // ... другие статусы ...
                ]
            }
        }
        ```
        Здесь `8824470` - ID воронки, `74304782` - ID статуса "CHATGPT".

### Переменные для ID в `.env` файлах:

Убедитесь, что следующие переменные установлены в ваших `.env.test` и `.env.production` файлах с корректными ID для соответствующего окружения:

*   `AMO_MAIN_PIPELINE_ID`
*   `AMO_CHATGPT_STATUS_ID`
*   `AMO_FINAL_OPERATOR_STATUS_ID`
*   `AMO_CF_ID_PAYMENT_LINK`
*   `AMO_CF_ID_REQUEST_AMOUNT`
*   `AMO_CF_ID_REQUEST_CURRENCY`
*   `AMO_CURRENCY_ENUM_ID_USD`
*   `AMO_CURRENCY_ENUM_ID_EUR`
*   `AMO_CURRENCY_ENUM_ID_KZT`
*   `AMO_CURRENCY_ENUM_ID_RUB`
*   `AMO_CURRENCY_ENUM_ID_GBP`
*   `AMO_CURRENCY_ENUM_ID_TL`
*   `AMO_CURRENCY_ENUM_ID_TRY`

## Общая схема работы с лидами

Лиды в системе могут поступать из двух источников и обрабатываются следующим образом:

1.  **Лиды из AmoCRM**:
    *   Поступают через вебхук на скрипт `amogt/amo2json.php`.
    *   Данные о лиде (включая `dealId` и `paymentUrl`) сохраняются в основной файл данных лидов: `amogt/allLeads.json`.
    *   Этот файл используется для дальнейшей обработки и отображения.

2.  **Лиды от Партнеров**:
    *   Поступают через основной API `amogt/gpt_payment_api/api.php` с `action=submit_partner_lead`.
    *   Партнер передает массив лидов, каждый из которых должен содержать `paymentUrl` (обязательно) и опционально `dealId` (уникальный ID лида со стороны партнера).
    *   Перед сохранением, `dealId` каждого лида проверяется на дубликат в файле `amogt/recieved_api_ids.txt`. Если ID уже существует, лид пропускается. Новые ID добавляются в этот файл.
    *   Данные успешно принятых лидов (с добавлением `partnerId` и `partner_name` на основе API токена) также сохраняются в основной файл `amogt/allLeads.json`.

3.  **Обработка лидов и Отчетность (Операторы/Zeno)**:
    *   Система автоматизации (например, Zeno) получает список лидов для обработки из `amogt/alldeals_json.php`.
    *   После выполнения работы по лиду, система автоматизации (или оператор вручную) отправляет отчет через эндпоинт `amogt/zeno_report.php`.
    *   **Параметры `zeno_report.php`**:
        *   `GET id={lead_id}`: Где `{lead_id}` - это `dealId` из `allLeads.json`.
        *   `GET status={status}`: Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
        *   `GET amount={amount}` (optional): Сумма (если применимо).
        *   `GET currency={currency}` (optional): Валюта (если применимо).
        *   `GET email={email}` (optional): Email (если применимо).
        *   `GET card={card}` (optional): Карта (если применимо).
        *   `GET partner_id={partner_id}` (optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
        *   *Любые другие поля, которые система автоматизации хочет передать в отчете через GET-параметры.*
    *   **Логика `zeno_report.php`**:
        *   Все отчеты сохраняются в `amogt/zeno_report.json`.
        *   Если в запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
        *   Если `partner_id` **отсутствует**:
            *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/id_of_deals_sent_to_amo.txt`).
            *   Если `lead_id` новый, он добавляется в `id_of_deals_sent_to_amo.txt`.
            *   Производится поиск сделки в AmoCRM по `lead_id`.
            *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `id_of_deals_sent_to_amo.txt` служат для предотвращения дублирующей обработки и обновлений.

## Эндпоинты API

### Основной API Партнеров (Платежи и Прием Лидов)

Все запросы к этому API должны отправляться на `ваш_домен/amogt/gpt_payment_api/api.php`.
Метод передачи параметров: `GET` или `POST` (для `submit_partner_lead` - `POST` с JSON телом).
Формат ответа: JSON.

#### Общие параметры для большинства запросов (если не указано иное):
*   `api_token` (string, required): Уникальный API токен партнера. Передается как GET/POST параметр, либо в JSON теле для `submit_partner_lead`.

#### 1. Получение баланса партнера
*   **Action**: `get_balance`
    *   **Метод**: `GET`
    *   **Параметры**: `api_token`
    *   **Успешный ответ (200 OK)**:
        ```json
        {
            "status": "success",
            "balance": 100.50,
            "currency": "USD",
            "partner_name": "Имя партнера"
        }
        ```
    *   **Ошибки**: 401 (неверный токен), 500 (внутренняя ошибка сервера).

#### 2. Расчет стоимости платежа
*   **Action**: `calculate_payment_cost`
    *   **Метод**: `GET`
    *   **Параметры**:
        *   `api_token` (string, required): API токен партнера.
        *   `amount` (float, required): Сумма платежа в валюте ChatGPT (USD).
        *   `currency` (string, required): Валюта платежа (например, "USD").
    *   **Успешный ответ (200 OK)**:
        ```json
        {
            "status": "success",
            "original_amount": 20.00,
            "original_currency": "USD",
            "converted_amount": 18.00,
            "converted_currency": "EUR",
            "exchange_rate": 0.9
        }
        ```
    *   **Ошибки**: 400 (неверные параметры), 401, 500.

#### 3. Проведение платежа
*   **Action**: `make_payment`
    *   **Метод**: `POST`
    *   **Параметры**:
        *   `api_token` (string, required): API токен партнера.
        *   `amount` (float, required): Сумма платежа в валюте ChatGPT (USD).
        *   `currency` (string, required): Валюта платежа (например, "USD").
        *   `transaction_id` (string, required): Уникальный ID транзакции со стороны партнера для предотвращения дублей.
        *   `description` (string, optional): Описание платежа.
    *   **Успешный ответ (200 OK)**:
        ```json
        {
            "status": "success",
            "message": "Payment processed successfully.",
            "transaction_id": "уникальный_ID_транзакции",
            "new_balance": 80.50
        }
        ```
    *   **Ошибки**: 400, 401, 402 (недостаточно средств), 409 (дубликат `transaction_id`), 500.

#### 4. Получение статуса транзакции
*   **Action**: `get_transaction_status`
    *   **Метод**: `GET`
    *   **Параметры**:
        *   `api_token` (string, required): API токен партнера.
        *   `transaction_id` (string, required): ID транзакции, статус которой нужно получить.
    *   **Успешный ответ (200 OK)**:
        ```json
        {
            "status": "success",
            "transaction_id": "уникальный_ID_транзакции",
            "payment_status": "completed", // "pending", "failed", "completed"
            "amount": 20.00,
            "currency": "USD",
            "timestamp": "2023-10-27 10:00:00"
        }
        ```
    *   **Ошибки**: 400, 401, 404 (транзакция не найдена), 500.

#### 5. Отправка лидов от партнера (пакетная)
*   **Action**: `submit_partner_lead`
*   **Метод**: `POST`
*   **Формат запроса**: JSON (тело запроса)
*   **Параметры (в теле JSON-запроса)**:
    *   `action` (string, required): Должен быть `"submit_partner_lead"`.
    *   `api_token` (string, required): Уникальный API токен партнера для аутентификации.
    *   `lead_data` (array, required): Массив JSON-объектов, где каждый объект представляет лид. Каждый лид должен содержать как минимум `paymentUrl`. Поля `dealId`, `created_at` и `last_updated` всегда генерируются сервером и не принимаются от партнера. Любые другие пользовательские поля также могут быть включены. Поле `partnerId` будет добавлено/перезаписано сервером на основе `api_token`.
*   **Пример тела запроса**:
    ```json
    {
        "action": "submit_partner_lead",
        "api_token": "ВАШ_API_ТОКЕН",
        "lead_data": [
            {
                "paymentUrl": "https://pay.openai.com/...",
                "custom_field_example": "some_value"
            },
            {
                "paymentUrl": "https://another-service.com/pay/...",
                "custom_notes": "Another lead with different data"
            }
        ]
    }
    ```
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Processed X leads. Added to main list: Y, Updated in main list: Z.",
        "processed_count": X,
        "added_to_main_list_count": Y,
        "updated_in_main_list_count": Z,
        "errors": [] // Массив ошибок, если какие-то лиды не удалось обработать или были дублями
    }
    ```
*   **Ошибки**: 400, 401, 405, 429, 500.

## Инструкция для Zeno автоматизации (и других систем обработки лидов)

Этот раздел описывает, как внешние системы автоматизации (например, Zeno) должны взаимодействовать с API для получения списка задач (лидов) и отправки отчетов об их выполнении.

### 1. Получение списка активных лидов (задач)

Для получения полного списка текущих лидов, которые требуют обработки, система автоматизации должна выполнить GET-запрос к следующему эндпоинту:

*   **URL**: `https://ваш_домен/amogt/amodeals_json.php` (без параметров)
*   **Метод**: `GET`
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "deals": [
            {
                "dealId": "14252569",
                "paymentUrl": "https://pay.openai.com/...",
                "created_at": "2025-06-09 08:47:02",
                "last_updated": "2025-06-09 08:47:02",
                "partnerId": "partner_id_если_есть", // Поле будет присутствовать, если лид от партнера
                "partner_name": "Имя партнера если есть" 
                // ... другие поля, которые были сохранены для лида ...
            },
            // ... другие лиды
        ],
        "total": X, // Общее количество лидов
        "message": "Current deals in JSON file.",
        "info": {
            'usage' => 'How to use this script:',
            'delete_all' => 'To delete all deals: ?deleteall=1',
            'view_all' => 'To view all deals: access without parameters',
            'example_delete_all' => 'Example: amodeals_json.php?deleteall=1',
            'note' => 'This script primarily manages a local JSON file of deal IDs.'
        }
    }
    ```
*   **Примечание**: Система автоматизации должна сама определить, какие из полученных лидов являются "новыми" или "необработанными" (например, сравнивая с ранее полученными ID или проверяя наличие отчета в `zeno_report.json`).

### 2. Отправка отчета о выполнении задачи

После выполнения работы по лиду, система автоматизации отправляет отчет через следующий эндпоинт:

*   **URL**: `https://ваш_домен/amogt/zeno_report.php?id={lead_id}`
    *   `{lead_id}`: ID лида (соответствует `dealId` из файла `allLeads.json`).
*   **Метод**: `GET` (данные передаются через GET-параметры)
*   **Параметры (в GET-запросе)**:
    *   `status` (string, required): Статус обработки лида. Ожидаемые значения: "Успешно", "ОШИБКА!".
    *   `amount` (string, optional): Сумма (если применимо).
    *   `currency` (string, optional): Валюта (если применимо).
    *   `email` (string, optional): Email (если применимо).
    *   `card` (string, optional): Карта (если применимо).
    *   `partner_id` (string, optional): ID партнера, если отчет относится к партнерскому лиду (это значение можно взять из поля `partnerId` лида, полученного из `amodeals_json.php`). **Если это поле передано, обновление данных в AmoCRM производиться не будет.**
    *   *Любые другие поля, которые система автоматизации хочет передать в отчете.*
*   **Успешный ответ (200 OK)**:
    ```json
    {
        "status": "success",
        "message": "Report received and processed.",
        "report_id": "уникальный_ID_отчета",
        "lead_id": "ID_лида",
        "amo_status": "success/skipped/failed",
        "amo_message": "Сообщение об обновлении AmoCRM"
    }
    ```
*   **Ошибки**: 400 (неверные параметры), 500 (внутренняя ошибка сервера).
*   **Логика на стороне сервера (`zeno_report.php`)**:
    1.  Отчет сохраняется в `amogt/zeno_report.json`.
    2.  Если в запросе **присутствует `partner_id`**, это означает, что отчет по партнерскому лиду, и никаких действий с AmoCRM не производится.
    3.  Если `partner_id` **отсутствует**:
        *   Скрипт проверяет, не был ли уже обработан данный `lead_id` для AmoCRM (по файлу `amogt/id_of_deals_sent_to_amo.txt`).
        *   Если не обработан, `lead_id` добавляется в `amogt/id_of_deals_sent_to_amo.txt`.
        *   Производится поиск сделки в AmoCRM по `lead_id`.
        *   Если сделка найдена и ее поле статуса ("Статус оплаты ChatGPT") пустое, то поля сделки обновляются, и, если отчетный статус не "ОШИБКА!", сделка переводится на этап "Финальный Операторский".

Таким образом, `amogt/allLeads.json` является центральным хранилищем данных о лидах, а `recieved_api_ids.txt` и `id_of_deals_sent_to_amo.txt` служат для предотвращения дублирующей обработки и обновлений.
