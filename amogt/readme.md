# Структура и описание файлов в папке amogt/

## Файлы конфигурации и окружения

*   `.env`: Файл, содержащий переменные окружения, такие как ключи API, ID Google Drive файлов и другие секретные параметры. **Важно:** Этот файл должен быть защищен и не должен попадать в публичные репозитории.
*   `.gitignore`: Определяет файлы и папки, которые Git должен игнорировать (например, `mycity*`, `amo_tokens.json`, `*.json`, `gpt_payment_api/data/`).
*   `.htaccess`: Файл конфигурации веб-сервера Apache, который запрещает прямой доступ к некоторым файлам, содержащим конфиденциальную информацию (например, `mycity*`, `amo_tokens.json`, `.json`, `.env`, `gpt_payment_api/data/.*\.json`).
*   `.wakatime-project`: Файл, используемый сервисом Wakatime для отслеживания времени, затраченного на проект.

## Файлы для интеграции с Google Drive

*   `my-project-1337-458418-4b4c595d74d5.json`: Файл ключа сервисного аккаунта Google, используемый для аутентификации в Google Drive API.
*   `driveutils.php`: Содержит функции для работы с Google Drive API, такие как `getDriveService()`, `downloadFileFromDrive()` и `uploadFileToDrive()`.

## Файлы для интеграции с AMO CRM

*   `amo_tokens.json`: Файл, в котором хранятся токены доступа и обновления для API AMO CRM.
*   `config.php`: Файл конфигурации, определяющий константы, используемые для доступа к API AMO CRM и Google Drive, а также имена пользовательских полей.
*   `amo2excel.php`: Скрипт, обрабатывающий вебхуки из AMO CRM и записывающий данные в Google Sheets.
*   `excel2amo.php`: Скрипт, который считывает данные из Google Sheets и обновляет соответствующие сделки в AMO CRM.
*   `amo_fields.txt`: Содержит JSON-ответ от AMO CRM API, содержащий определения пользовательских полей. Используется для сопоставления полей в Excel с полями в AMO CRM.

## Файлы для управления сделками

*   `blocked_deals.txt`: Файл, содержащий список ID сделок, которые заблокированы для обработки.
*   `blocked_webhook_deals.txt`: Файл, содержащий список ID сделок, которые были заблокированы после обработки вебхуком.
*   `amodeals_json.php`: Скрипт, который выдает JSON из таблицы с текущими входящими сделками. Поддерживает удаление сделок по ID и удаление всех сделок. Данные берутся из AMO CRM API. **Важно:** Этот скрипт напрямую обращается к API AmoCRM и требует валидный токен.
*   `pipelines.json`: Содержит информацию о воронках продаж в AMO CRM.

## API для оплаты ChatGPT

*   `gpt_payment_api/`: Папка, содержащая API для предоставления партнерам доступа к разработкам по оплате ChatGPT.
    *   `readme.md`: Подробное описание API для оплаты ChatGPT (см. этот файл).
    *   `api.php`: Основной файл API, обрабатывающий запросы от партнеров.
    *   `admin/`: Папка с административной панелью для управления партнерами, курсами валют и просмотра транзакций.
    *   `data/`: Папка для хранения данных API (партнеры, курсы, транзакции) в JSON файлах. **Важно:** Эта папка должна быть защищена от прямого доступа через веб.
    *   `lib/`: Папка с библиотеками, используемыми API (например, для работы с "базой данных" JSON, аутентификации партнеров, логики платежей).

## Другие файлы

*   `composer.json`: Файл, описывающий зависимости PHP проекта для Composer.
*   `composer.lock`: Файл, содержащий информацию о конкретных версиях установленных зависимостей.
*   `composer-setup.php`: Скрипт для установки Composer.
*   `index.php`: Основной файл, который запускает синхронизацию данных между Excel и AMO CRM.
*   `logger.php`: Файл, содержащий функции для логирования событий и ошибок.
*   `parseStripe.js`: Скрипт для извлечения информации об оплате со страницы Stripe.
*   `debug_page.html`: HTML файл, используемый для отладки.
*   `logs/`: Папка для хранения лог-файлов.

## Описание основных скриптов

*   `index.php`:
    *   Загружает переменные окружения из `.env`.
    *   Проверяет доступ к AMO CRM API.
    *   Запускает синхронизацию данных из Excel в AMO CRM (`excel2amo.php`).
    *   Содержит логику для обработки вебхуков (если реализовано).
*   `excel2amo.php`:
    *   Считывает данные из Excel-файла на Google Drive.
    *   Обновляет соответствующие сделки в AMO CRM.
    *   Использует `driveutils.php` для работы с Google Drive API.
    *   Использует `logger.php` для логирования.
*   `amo2excel.php`:
    *   Обрабатывает вебхуки из AMO CRM.
    *   Записывает данные о сделках в Excel-файл на Google Drive.
    *   Использует `driveutils.php` для работы с Google Drive API.
    *   Использует `logger.php` для логирования.
*   `amodeals_json.php`:
    *   Выдает JSON из таблицы с текущими входящими сделками.
    *   Поддерживает удаление сделок по ID и удаление всех сделок. Данные берутся из AMO CRM.
*   `gpt_payment_api/api.php`:
    *   Предоставляет эндпоинты для партнеров для работы с системой оплаты ChatGPT.
    *   Требует аутентификацию по API токену.
    *   Позволяет получать баланс, стоимость платежа, обрабатывать платежи и проверять статус транзакций.

## Зависимости

*   PHP
*   Composer
*   Google API Client Library for PHP
*   PhpSpreadsheet

## Замечания

*   Файлы `.env`, `mycity2_key.json`, `amo_tokens.json` и содержимое папки `gpt_payment_api/data/` должны быть защищены и не должны попадать в публичные репозитории.
*   Для продакшена рекомендуется использовать PM2 для управления процессом (если применимо к PHP-скриптам, работающим в фоне, или Node.js скриптам). Для PHP веб-сервера (Apache/Nginx) стандартные методы управления.
