# Database Migration Check Middleware

## –û–ø–∏—Å–∞–Ω–∏–µ

Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –æ—à–∏–±–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –Ω–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Django, –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–Ω—è—Ç–Ω–æ–≥–æ HTML-—Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π DEBUG-—Å—Ç—Ä–∞–Ω–∏—Ü—ã.

## –ü—Ä–æ–±–ª–µ–º–∞

–†–∞–Ω—å—à–µ –ø—Ä–∏ –Ω–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª:
```
ProgrammingError at /core/campaignchannel/
column core_channel.is_deleted does not exist
LINE 1: ...core_channel"."about", "core_channel"."language", "core_chan...
```

–≠—Ç–æ –±—ã–ª–æ –Ω–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ –¥–ª—è –Ω–µ–æ–ø—ã—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ç—Ä–µ–±–æ–≤–∞–ª–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è Django.

## –†–µ—à–µ–Ω–∏–µ

–°–æ–∑–¥–∞–Ω `DatabaseMigrationCheckMiddleware` –∫–æ—Ç–æ—Ä—ã–π:

1. **–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç** –∏—Å–∫–ª—é—á–µ–Ω–∏—è `ProgrammingError` –∏ `OperationalError`
2. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç** —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π:
   - "column does not exist"
   - "relation does not exist"
   - "table doesn't exist"
   - "no such column"
   - "unknown column"
3. **–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç** –∫—Ä–∞—Å–∏–≤—É—é HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–æ—à–∞–≥–æ–≤–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## –í–Ω–µ–¥—Ä–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω middleware –∫–ª–∞—Å—Å

–§–∞–π–ª: `web_app/core/middlewares.py`

```python
class DatabaseMigrationCheckMiddleware:
    """
    Middleware –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –æ—à–∏–±–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
    –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Ç—Ä–µ–π—Å–±–µ–∫–∞
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        try:
            response = self.get_response(request)
            return response
        except (ProgrammingError, OperationalError) as e:
            return self.handle_migration_error(e, request)
```

### 2. –ü–æ–¥–∫–ª—é—á—ë–Ω –≤ settings.py

–§–∞–π–ª: `web_app/web_app/settings.py`

```python
MIDDLEWARE = [
    "django_prometheus.middleware.PrometheusBeforeMiddleware",
    "core.middlewares.DatabaseMigrationCheckMiddleware",  # ‚Üê –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–µ—Ä–≤—ã–º
    "django.middleware.security.SecurityMiddleware",
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ middleware
]
```

**–í–∞–∂–Ω–æ:** Middleware –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑ –ø–µ—Ä–≤—ã—Ö, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –¥–æ –¥—Ä—É–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏

–ü—Ä–∏ –æ—à–∏–±–∫–µ –º–∏–≥—Ä–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:

- üé® **–°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞** —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º —Ñ–æ–Ω–æ–º
- üîß **–ò–∫–æ–Ω–∫—É –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫** "–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
- üìù **–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏** –≤ –∫—Ä–∞—Å–Ω–æ–π —Ä–∞–º–∫–µ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤/—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
- ‚úÖ **–ü–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é** —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π:
  - Docker
  - –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
  - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
- üí° **–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏** –Ω–∞ Django –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ—à–∏–±–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–π –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:

```python
logger.error(
    f"Migration error detected: {error_message} | "
    f"Path: {request.path} | Method: {request.method}"
)
```

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ production.

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–ù–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫—Ä–∞—Å–∏–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- **–î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –ë–î** ‚Üí –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –¥–∞–ª—å—à–µ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Django
- **–ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç** –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ –º–æ–¥–µ–ª—å

1. –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–∏–ª `is_deleted` –≤ –º–æ–¥–µ–ª—å `Channel`
2. –°–æ–∑–¥–∞–ª –º–∏–≥—Ä–∞—Ü–∏—é: `python manage.py makemigrations`
3. –ó–∞–±—ã–ª –ø—Ä–∏–º–µ–Ω–∏—Ç—å: `python manage.py migrate`
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ `/core/campaignchannel/`
5. **–†–∞–Ω—å—à–µ:** –¢—Ä–µ–π—Å–±–µ–∫ ProgrammingError
6. **–¢–µ–ø–µ—Ä—å:** –ö—Ä–∞—Å–∏–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Production deploy –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π

1. –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω –Ω–∞ production
2. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –±–µ–∑ `migrate`
3. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ –∞–¥–º–∏–Ω–∫–µ
4. **Middleware –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É**
5. –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–æ–≤—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –∫–æ–º–∞–Ω–¥–µ

1. –°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –ó–∞–ø—É—Å—Ç–∏–ª `make up-b`
3. –ó–∞—à—ë–ª –Ω–∞ `http://localhost:8000`
4. –í–∏–¥–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø—Ä–æ –º–∏–≥—Ä–∞—Ü–∏–∏
5. –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

## HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–∫–∏

–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç:

```html
<div class="container">
  <div class="header">
    <div class="icon">üîß</div>
    <h1>–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h1>
    <div class="subtitle">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å –º–æ–¥–µ–ª—è–º–∏ Django</div>
  </div>

  <div class="error-box">
    <strong>–û—à–∏–±–∫–∞ –ë–î:</strong><br>
    {error_message}
  </div>

  <div class="solution">
    <h2>‚úÖ –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:</h2>
    <!-- –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ -->
  </div>

  <div class="note">
    <strong>‚ÑπÔ∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong><br>
    –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –±—Ä–∞—É–∑–µ—Ä–∞.
  </div>
</div>
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ middleware (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–í `settings.py` –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É:

```python
MIDDLEWARE = [
    # "core.middlewares.DatabaseMigrationCheckMiddleware",  # ‚Üê –û—Ç–∫–ª—é—á–µ–Ω–æ
]
```

### –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è HTML-—à–∞–±–ª–æ–Ω–∞

–ú–µ—Ç–æ–¥ `_generate_migration_error_page()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML-—Å—Ç—Ä–æ–∫—É. –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ:

```python
def _generate_migration_error_page(self, error_message):
    return f"""
    <!DOCTYPE html>
    <html lang="ru">
    <!-- –í–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π HTML -->
    </html>
    """
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤

–ï—Å–ª–∏ –°–£–ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö, –¥–æ–±–∞–≤—å—Ç–µ –≤ —Å–ø–∏—Å–æ–∫:

```python
migration_keywords = [
    "column", "does not exist",
    "relation", "does not exist",
    "table", "doesn't exist",
    "no such column",
    "unknown column",
    "your custom keyword",  # ‚Üê –ù–æ–≤–æ–µ
]
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Overhead

- **Negligible** ‚Äì middleware —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (pass-through)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML (~200 —Å—Ç—Ä–æ–∫) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑ –Ω–∞ –æ—à–∏–±–∫—É

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ **–≤—Å–µ—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö** (dev, staging, production)
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –ø—Ä–∏—á–∏–Ω—É –≤ production
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `python manage.py makemigrations`
2. **–ù–ï** –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –µ—ë: –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ `migrate`
3. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±—É—é –∞–¥–º–∏–Ω-—Å—Ç—Ä–∞–Ω–∏—Ü—É
4. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫—Ä–∞—Å–∏–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–∫–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –í tests/test_middleware.py
from django.test import TestCase, RequestFactory
from core.middlewares import DatabaseMigrationCheckMiddleware
from django.db.utils import ProgrammingError

class MigrationMiddlewareTest(TestCase):
    def test_catches_migration_error(self):
        factory = RequestFactory()
        request = factory.get('/admin/')

        def get_response(request):
            raise ProgrammingError("column core_channel.is_deleted does not exist")

        middleware = DatabaseMigrationCheckMiddleware(get_response)
        response = middleware(request)

        self.assertEqual(response.status_code, 500)
        self.assertIn("–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π", response.content.decode())
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

### 1. Django system checks

Django –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø—Ä–æ–≤–µ—Ä–æ–∫, –Ω–æ –æ–Ω–∞:
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
- –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –¢—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—Å–∫–∞ `python manage.py check --database default`

### 2. Custom error pages (500.html)

Django –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å 500.html, –Ω–æ:
- –ù–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–ª–∏—á–∞—Ç—å —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
- –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
- –¢—Ä–µ–±—É–µ—Ç `DEBUG = False`

### 3. Monitoring tools (Sentry, etc.)

Monitoring —Ä–µ—à–µ–Ω–∏—è –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è production, –Ω–æ:
- –ù–µ –ø–æ–º–æ–≥–∞—é—Ç –ª–æ–∫–∞–ª—å–Ω—ã–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º
- –¢—Ä–µ–±—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

**–í—ã–≤–æ–¥:** Middleware –¥–æ–ø–æ–ª–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ä–µ—à–∞–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É UX.

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ Django 3.2+
- ‚úÖ Django 4.x
- ‚úÖ Django 5.x
- ‚úÖ PostgreSQL, MySQL, SQLite
- ‚úÖ Docker –∏ bare-metal deployments

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** Middleware –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- **–ü—Ä–∏—á–∏–Ω–∞:** –î—Ä—É–≥–∏–µ middleware –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–Ω—å—à–µ
- **–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ `DatabaseMigrationCheckMiddleware` –ø–µ—Ä–≤—ã–º –≤ —Å–ø–∏—Å–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ —Å—Ç–∏–ª–∏–∑—É–µ—Ç—Å—è
- **–ü—Ä–∏—á–∏–Ω–∞:** Content-Security-Policy –±–ª–æ–∫–∏—Ä—É–µ—Ç inline —Å—Ç–∏–ª–∏
- **–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å–∏—Ç–µ —Å—Ç–∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π CSS-—Ñ–∞–π–ª –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ CSP

### FAQ

**Q: –ë—É–¥–µ—Ç –ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ views (async def)?**
A: –î–∞, middleware –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–æ –∏—Ö –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Slack/Telegram –ø—Ä–∏ –æ—à–∏–±–∫–µ?**
A: –î–∞, –¥–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ webhook –≤ –º–µ—Ç–æ–¥ `handle_migration_error()`:

```python
def handle_migration_error(self, exception, request):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Slack
    send_slack_notification(f"Migration error: {error_message}")

    return HttpResponse(html_content, status=500)
```

**Q: –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Docker?**
A: –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –≤–µ—Ç–∫—É —Å –Ω–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π:

```bash
docker-compose -f web_app/docker-compose.yml exec web-app python manage.py makemigrations --empty core
# –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ migrate
curl http://localhost:8000/admin/
```

## –°—Å—ã–ª–∫–∏

- [Django Middleware Documentation](https://docs.djangoproject.com/en/stable/topics/http/middleware/)
- [Django Database Errors](https://docs.djangoproject.com/en/stable/ref/exceptions/#database-exceptions)
- [TeleWin GitHub](https://github.com/marsiandeployer/TELEWIN)

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-17
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-17
