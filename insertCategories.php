<?php

// ** ВНИМАНИЕ! **  Этот скрипт предназначен для ОДНОРАЗОВОГО импорта.
// Перед использованием ОБЯЗАТЕЛЬНО сделайте резервную копию базы данных!
// Запускайте скрипт ТОЛЬКО на тестовом или development-окружении,
// НИКОГДА на production-сайте без предварительного тестирования.
// Скрипт предполагает, что у вас уже установлена чистая WordPress.

// ** Подключение к базе данных WordPress **

include("wp-config.php"); // Подключаем конфигурацию WordPress

$db = new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);

if ($db->connect_error) {
    die("Ошибка подключения к базе данных: " . $db->connect_error);
}

// Устанавливаем кодировку соединения (важно для кириллицы)
$db->set_charset("utf8mb4");

// Префикс таблиц (измените, если у вас другой)
$table_prefix = 'wp_hababru_'; // ИСПОЛЬЗУЙТЕ ВАШ ПРЕФИКС!

// Функция транслитерации
function transliterate($text) {
    $cyr = [
        'а', 'б', 'в', 'г', 'д', 'е', 'ё', 'ж', 'з', 'и', 'й', 'к', 'л', 'м', 'н', 'о', 'п',
        'р', 'с', 'т', 'у', 'ф', 'х', 'ц', 'ч', 'ш', 'щ', 'ъ', 'ы', 'ь', 'э', 'ю', 'я',
        'А', 'Б', 'В', 'Г', 'Д', 'Е', 'Ё', 'Ж', 'З', 'И', 'Й', 'К', 'Л', 'М', 'Н', 'О', 'П',
        'Р', 'С', 'Т', 'У', 'Ф', 'Х', 'Ц', 'Ч', 'Ш', 'Щ', 'Ъ', 'Ы', 'Ь', 'Э', 'Ю', 'Я', ' '
    ];
    $lat = [
        'a', 'b', 'v', 'g', 'd', 'e', 'io', 'zh', 'z', 'i', 'y', 'k', 'l', 'm', 'n', 'o', 'p',
        'r', 's', 't', 'u', 'f', 'h', 'ts', 'ch', 'sh', 'sht', '', 'i', '', 'e', 'yu', 'ya',
        'A', 'B', 'V', 'G', 'D', 'E', 'Io', 'Zh', 'Z', 'I', 'Y', 'K', 'L', 'M', 'N', 'O', 'P',
        'R', 'S', 'T', 'U', 'F', 'H', 'Ts', 'Ch', 'Sh', 'Sht', '', 'I', '', 'E', 'Yu', 'Ya', '-'
    ];
    $text = str_replace($cyr, $lat, $text);
    $text = preg_replace('/[^A-Za-z0-9\-]/', '', $text); // Убираем все, кроме букв, цифр и дефиса
    $text = preg_replace('/-+/', '-', $text);       // Убираем повторяющиеся дефисы
    $text = trim($text, '-');                      // Убираем дефисы в начале и конце
    return strtolower($text);
}


// Массив с категориями и подкатегориями (структура из предыдущего ответа)
$categories = [
    'Тексты и Переводы' => [
        'description' => 'Услуги по написанию, редактированию и переводу текстов.',
        'children' => [
            'Контент' => [
                'description' => 'Создание контента для различных целей.',
                'children' => [
                    'Статьи и записи в блогах' => 'заказать статью для блога',
                    'Контент-стратегия' => 'разработка контент-стратегии',
                    'Контент для веб-сайтов' => 'тексты для сайта',
                    'Сценарии' => 'заказать сценарий',
                    'Креативное письмо' => 'креативный копирайтинг',
                    'Тексты для подкастов' => 'сценарий подкаста',
                    'Речи' => 'написание речи',
                    'Исследования и сводки' => 'заказать реферат',
                ]
            ],
            'Редактура и Корректура' => [
              'description' => 'Редактирование и проверка текстов.',
              'children' => [
                    'Редактура и корректура' => 'редактура текста',
                    'Редактирование AI-контента' => 'редактура текста нейросети',
                    'Рекомендации по текстам' => 'аудит текста',
                ]
            ],

            'Издание книг и электронных книг' => [
                'description' => 'Помощь в издании',
                'children' => [
                  'Написание книг и электронных книг' =>  'написать книгу на заказ',
                  'Редактура книг' => 'редактура книги',
                  'Бета-ридинг' => 'бета-ридер для книги',
                ]

            ],

             'Тексты для карьеры' => [
                'description' => 'Помощь в составлении документов.',
                'children' => [
                   'Написание резюме' => 'заказать резюме',
                   'Сопроводительные письма' => 'сопроводительное письмо образец',
                   'Профили LinkedIn' => 'оформление профиля LinkedIn',
                   'Описания вакансий' => 'составить описание вакансии',
                ]
             ],

            'Разное' => [
                'description' => 'Другие услуги.',
                'children' => [
                  'Разработка контента для онлайн-обучения' => 'разработка онлайн-курса',
                  'Техническое писательство' => 'технический писатель',
                ]
            ],

            'Бизнес и Маркетинговые Тексты' => [
                'description' => 'Создание текстов для бизнеса.',
                'children' => [
                  'Голос и тон бренда' =>  'разработка tone of voice',
                  'Названия компаний и слоганы' => 'придумать название компании',
                  'Кейсы (Case Studies)' => 'написание кейсов',
                  'White Papers' => 'заказать white paper',
                  'Описание товаров' =>  'описание товара для интернет-магазина',
                  'Тексты для рекламы (Ad Copy)' => 'текст для рекламы',
                  'Тексты для продаж' => 'продающий текст',
                  'Тексты для email-рассылок' => 'текст для email-рассылки',
                  'Тексты для социальных сетей' => 'тексты для соцсетей',
                  'Пресс-релизы' => 'написать пресс-релиз',
                  'UX-тексты' => 'UX-копирайтинг',
                ]
            ],

            'Перевод и транскрипция' => [
                'description' => 'Перевод и расшифровка аудио/видео.',
                'children' =>[
                  'Перевод' => 'перевод текста',
                  'Локализация' => 'локализация сайта',
                  'Транскрипция' => 'транскрибация аудио',
                  'Синхронный перевод' => 'синхронный переводчик',
                ]
            ],
            'Отраслевой контент' => [
              'description' => 'Специфический контент для разных отраслей.',
              'children' => [
                'Бизнес, финансы и право' => 'юридический перевод',
                'Здравоохранение и медицина' => 'медицинский перевод',
                'Интернет и технологии' => 'IT-перевод',
                'Новости и политика' =>  'перевод новостей',
                'Маркетинг' => 'маркетинговый перевод',
                'Недвижимость' => 'описание недвижимости',
              ]
            ],

        ],
    ],
    'Цифровой Маркетинг' => [
        'description' => 'Услуги по продвижению в интернете.',
        'children' => [
            'Поисковый маркетинг' => [
                'description' => 'SEO и локальное продвижение.',
                'children' => [
                    'Поисковая оптимизация (SEO)' => 'SEO-продвижение сайта',
                    'Локальное SEO' => 'локальное SEO продвижение',
                ],
            ],
            'Социальные сети' =>[
                'description' => 'Продвижение в социальных сетях.',
                'children' => [
                   'Маркетинг в социальных сетях' => 'SMM-продвижение',
                    'Продвижение через инфлюенсеров' => 'реклама у блогеров',
                ],
            ],
             'Управление сообществом' => [
                  'description' => 'Помощь в работе с клиентами.',
                  'children' => [
                    'Модерация онлайн сообщества' => 'Модерация онлайн сообщества',
                    'Создание FAQ для бизнеса' => 'Создание FAQ для бизнеса',
                  ],
             ],

            'Методы и техники' => [
                'description' => 'Различные методы онлайн-маркетинга.',
                'children' => [
                  'Email-маркетинг' => 'email-рассылка',
                  'Гостевые посты' => 'написание гостевых постов',
                  'Партнерский маркетинг' => 'партнерские программы',
                ],
            ],
             'PR' => [
                'description' => 'Онлайн пиар.',
                'children' =>[
                   'Онлайн пиар' => 'Онлайн пиар',
                   'Публикация в СМИ' => 'Публикация в СМИ',
                ]
             ],

            'Аналитика и Стратегия' => [
              'description' => 'Аналитика и разработка стратегий.',
              'children' => [
                'Маркетинговая стратегия' => 'разработка маркетинговой стратегии',
                'Маркетинговые концепции и идеи' => 'генерация идей для маркетинга',
                'Консультации по маркетингу' => 'Консультация по маркетингу',
              ]
            ],

        ],
    ],
    'Бизнес' => [
        'description' => 'Услуги для бизнеса.',
        'children' => [
          'Создание и Консалтинг' => [
              'description' => 'Консультации и помощь в создании.',
              'children' => [
                'Исследование рынка' => 'исследование рынка',
                'Бизнес-планы' => 'написание бизнес-плана',
                'Бизнес-консалтинг' => 'бизнес-консультант',
                'HR-консалтинг' => 'HR-консультант',
                'AI-консалтинг' => 'внедрение ИИ в бизнес',
              ],
          ],
           'Юридические Услуги' => [
            'description' => 'Услуги юристов.',
            'children' => [
               'Юридические документы и контракты' => 'составление договора',
               'Юридические исследования' => 'юридическое исследование',
               'Общие юридические консультации' => 'юридическая консультация',
              ],
            ],
           'Операции и Управление' => [
            'description' => 'Операции и Управление.',
            'children' => [
               'Виртуальный помощник' => 'виртуальный ассистент',
               'Управление проектами' => 'управление проектами',
              ],
            ],
            'Продажи и Обслуживание Клиентов' =>[
              'description' => 'Услуги по продажам.',
              'children' =>[
                  'Продажи' => 'Скрипты продаж',
                  'Лидогенерация' => 'лидогенерация',
                  'Служба поддержки' => 'Сценарии поддержки клиентов',
                ],
            ],
        ],
    ],
    'Финансы' => [
      'description' => 'Финансовые услуги.',
      'children' => [
         'Бухгалтерские услуги' => [
            'description' => 'Услуги бухгалтера.',
            'children' => [
               'Финансовая отчетность' => 'составление финансовой отчетности',
                'Бухгалтерский учет' => 'ведение бухгалтерского учета',
                'Управление заработной платой' => 'расчет заработной платы',
            ],
         ],

        'Корпоративные финансы' => [
            'description' => 'Управление финансами компании.',
            'children' => [
              'Due Diligence' => 'due diligence',
              'Оценка стоимости' =>  'оценка бизнеса',
              'Консультирование по слияниям и поглощениям' => 'сопровождение сделок M&A',
              'Стратегия корпоративных финансов' => 'финансовая стратегия',
             ],
          ],
          'Налоговое консультирование' => [
            'description' => 'Помощь в вопросах налогооблажения.',
            'children' =>[
                'Налоговые декларации' =>  'заполнение налоговой декларации',
                'Услуги по налоговой идентификации' => 'получение ИНН',
                'Налоговое планирование' => 'налоговое планирование',
                'Соблюдение налогового законодательства' => 'налоговый аудит',
                'Налоговые льготы' => 'получение налоговых льгот',
            ],
          ],
          'Финансовое планирование и анализ' =>[
            'description' => 'Планирование финансов.',
            'children' => [
              'Бюджетирование и прогнозирование' => 'составление бюджета',
              'Финансовое моделирование' => 'финансовая модель',
              'Анализ затрат' => 'анализ затрат',
              'Анализ акций' =>  'анализ акций',
            ],
          ],
         'Личные финансы и управление капиталом' =>[
            'description' => 'Личные финансы.',
            'children' =>[
              'Управление личным бюджетом' => 'составление личного бюджета',
              'Консультации по инвестициям' => 'консультация по инвестициям',
            ],
         ],
          'Привлечение средств' => [
            'description' => 'Привлечение средств.',
            'children' => [
              'Поиск инвесторов' => 'найти инвестора',
              'Презентации для инвесторов' =>  'презентация для инвесторов',
              'Консультации по привлечению средств' => 'фандрайзинг',
            ],
          ],
      ]
    ],

    'AI Сервисы' => [
      'description' => 'Сервисы с использованием ИИ.',
      'children' => [
        'AI Контент' =>[
          'description' => 'AI контент.',
          'children' => [
            'Редактирование AI-контента' => 'редактура текста нейросети',
            'Пользовательские промпты для написания текстов' => 'составление промптов',
          ],
        ],
      ]
    ],


    'Личностный Рост' => [
        'description' => 'Услуги для личностного роста.',
        'children' =>[
          'Самосовершенствование' => [
              'description' => 'Помощь в саморазвитии.',
              'children' => [
                'Онлайн-репетиторство' => 'репетитор онлайн',
                'Языковые уроки' => 'уроки языка онлайн',
                'Коучинг' => 'коуч',
                'Консультирование по вопросам карьеры' => 'карьерный консультант',
              ]
            ],
           'Досуг и Хобби' =>[
            'description' => 'Досуг и Хобби.',
            'children' => [
               'Астрология и экстрасенсорика' => 'консультация астролога',
              ],
           ],
            'Разное' => [
              'description' => 'Различные услуги.',
              'children' =>[
                'Семья и генеалогия' => 'составление родословной',
               ],
            ],
        ]
    ],
     'Консалтинг' => [
        'description' => 'Консалтинговые услуги.',
        'children' => [
          'Бизнес-консультанты' => [
            'description' => 'Консультирование по бизнесу.',
            'children' => [
              'Юридический консалтинг' => 'юридический консалтинг',
              'Бизнес-консалтинг' => 'бизнес-консультант',
              'HR-консалтинг' => 'HR-консультант',
              'AI-консалтинг' => 'внедрение ИИ в бизнес',
              'Бизнес-планы' => 'написание бизнес-плана',
             ],
          ],
          'Консультации по маркетинговой стратегии' =>[
            'description' => 'Маркетинговая стратегия.',
            'children' =>[
               'Маркетинговая стратегия' => 'разработка маркетинговой стратегии',
               'Контент-стратегия' => 'разработка контент-стратегии',
              ],
          ],
          'Консультации по данным' => [
            'description' => 'Консультирование по вопросам данных.',
            'children' =>[
              'Консалтинг по аналитике данных' => 'консультации по анализу данных',
            ],
          ],
           'Коучинг и советы' => [
              'description' => 'Коучинг.',
              'children' =>[
                'Консультирование по вопросам карьеры' => 'карьерный консультант',
                'Коучинг' => 'коуч',
               ],
           ],
            'Менторство' => [
                'description' => 'Менторство.',
                'children' => [
                   'Менторство в области написания текстов' => 'литературный редактор ментор',
                ],
            ],

        ],
    ],
    'Данные' => [
        'description' => 'Услуги по работе с данными.',
        'children' => [
           'Сбор данных' => [
              'description' => 'Услуги по сбору данных.',
              'children' => [
                  'Ввод данных' => 'ввод данных',
                'Ввод текста' =>  'набор текста',
                'Скрапинг данных' => 'скрапинг данных',
                'Форматирование данных' => 'форматирование данных',
                'Очистка данных' =>  'очистка данных',
                'Обогащение данных' => 'обогащение данных',
              ]
            ],

            'Обработка и управление данными' => [
                'description' => 'Обработка и управление.',
                'children' =>[
                  'Обработка данных' => 'обработка данных',
                  'Управление и защита данных' => 'защита данных',
                ],
            ],
        ],
    ],
];

// Функция для рекурсивного импорта категорий (с обработкой ошибок)
function import_categories($categories, $parent_id = 0, $db, $table_prefix) {
    foreach ($categories as $category_name => $data) {
        $description = '';
        $children = [];

        if(is_array($data)) {
             // Если есть описание и/или потомки
            $description = isset($data['description']) ? $db->real_escape_string($data['description']) : '';
             if(isset($data['children'])){
                $children = $data['children'];
             }

        } else {
            // Если это строка (ключевое слово, оно же описание)
            $description = $db->real_escape_string($data);
        }


        $slug = transliterate($category_name);
        $term_id = 0; // Инициализируем term_id

        // Проверяем, существует ли уже категория с таким slug
        $term_exists_result = $db->query("SELECT term_id FROM {$table_prefix}terms WHERE slug = '$slug'");

        if ($term_exists_result === false) {
            custom_log("Ошибка SQL при проверке существования категории '$category_name': " . $db->error);
            echo "<b style='color:red'>Ошибка при проверке категории '$category_name'! Смотрите custom_log сервера.</b><br>";
            continue; // Переходим к следующей категории
        }


        if ($term_exists_result->num_rows == 0) {
            // 1. Добавляем в wp_terms
            try {
                if (!$db->query("INSERT INTO {$table_prefix}terms (name, slug) VALUES ('$category_name', '$slug')")) {
                    throw new Exception("Ошибка INSERT в {$table_prefix}terms");
                }
                $term_id = $db->insert_id;
                if (!$term_id) {
                    throw new Exception("Не удалось получить insert_id для категории '$category_name' в {$table_prefix}terms");
                }


                // 2. Добавляем в wp_term_taxonomy
                if (!$db->query("INSERT INTO {$table_prefix}term_taxonomy (term_id, taxonomy, description, parent) VALUES ($term_id, 'category', '$description', $parent_id)")) {
                    throw new Exception("Ошибка INSERT в {$table_prefix}term_taxonomy");
                }

                echo "Добавлена категория: $category_name (ID: $term_id, Parent ID: $parent_id)<br>";


            } catch (Exception $e) {
                custom_log("Ошибка SQL при добавлении категории '$category_name': " . $e->getMessage() . " " . $db->error);
                echo "<b style='color:red'>Ошибка при добавлении категории '$category_name'! Смотрите custom_log сервера.</b><br>";
                continue; // Переходим к следующей категории
            }


            // Рекурсивно импортируем подкатегории
            if (!empty($children)) {
                import_categories($children, $term_id, $db, $table_prefix);
            }


        } else {
            $term_id = $term_exists_result->fetch_assoc()['term_id'];
            echo "Категория '$category_name' уже существует (ID: $term_id). Пропускаем.<br>";
             // Рекурсивно импортируем подкатегории, *если* они есть
            if (!empty($children)) {
                import_categories($children, $term_id, $db, $table_prefix); // Передаем existing term_id
            }
        }
        $term_exists_result->free_result(); // Освобождаем ресурсы
    }
}

// Запускаем импорт
import_categories($categories, 0, $db, $table_prefix);

$db->close();

echo "<br>Импорт завершен (или пропущены дубликаты).  Проверьте таблицу категорий в WordPress.";

?>